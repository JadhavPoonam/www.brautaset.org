<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Setting up SSL-enabled S3 redirection with CloudFormation</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Stig Brautaset">
<link rel="stylesheet" type="text/css" href="/css/main.css" />
<link rel="icon" type="image/png" href="/images/icon.png" />
<script type="text/javascript">
if(/superloopy.io/.test(window.location.hostname)) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-4113456-6', 'auto');
  ga('send', 'pageview');
}
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>

<div id="org-div-home-and-up">
  <a href="/"><img src="/images/logo.png" alt="Superloopy Logo"/></a>
  <nav>
    <ul>
      <li><a accesskey="H" href="/"> Home </a></li>
      <li><a accesskey="p" href="/publications.html"> Publications </a></li>
      <li><a accesskey="A" href="/about.html"> About </a></li>
      <li><a accesskey="c" href="/contact.html"> Contact </a></li>
      <li>Licence: <a accesskey="l" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a></li>
    </ul>
  </nav>
</div>
<div id="content">
<h1 class="title">Setting up SSL-enabled S3 redirection with CloudFormation</h1>
<div class="abstract">
<p>
I show how to create an S3 bucket for redirecting web requests, put it
behind a CloudFront distribution, and configured <i>this</i> with an SSL
certificate&#x2014;all via CloudFormation.
</p>

</div>

<p>
This is the third post in an ongoing <a href="adding-ssl.html">series</a> in which I move my blog to
HTTPS. In the <a href="route-53-cloudformation.html">previous post</a> I learnt how to set up DNS in Route 53
using CloudFormation and Sceptre. In this post I will learn how to set
up a redirection from the Apex domain (i.e. superloopy.io) to
www.superloopy.io.
</p>

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#outputs">Outputs</a></li>
<li><a href="#certificate">Certificate</a></li>
<li><a href="#s3-redirection">S3 Redirection bucket</a></li>
<li><a href="#cloudfront">CloudFront Distribution</a>
<ul>
<li><a href="#cloudfront-like-us-east-1">CloudFront <i>really</i> likes the <code>us-east-1</code> region</a></li>
</ul>
</li>
<li><a href="#testing-redirection">Testing that redirection works</a></li>
<li><a href="#complete-template">The completed template</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</div>
</div>

<div id="outline-container-org69c02b1" class="outline-2">
<h2 id="outputs"><a id="org69c02b1"></a>Outputs</h2>
<div class="outline-text-2" id="text-outputs">
<p>
In addition to <code>Parameters</code> and <code>Resources</code> this stack will have an
<a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/outputs-section-structure.html">Outputs</a> section. This will contain the domain name of the CloudFront
distribution created. We need this because later we will amend our DNS
template to set up an alias for that, rather than hard-code GitHub's
IP addresses in the <code>A</code> record for <code>superloopy.io</code>. The <code>Outputs</code> section is
at the top level of the YAML template, and looks like this:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>CloudFormation Outputs section</label><pre><code class="src src-yaml" id="orgf7e3499"><span style="color: #EF6C00;">Outputs</span>:
  <span style="color: #EF6C00;">ApexCloudFrontDomain</span>:
    <span style="color: #EF6C00;">Description</span>: &gt;-
      <span style="color: #689f38;">The CloudFront domain name for the Apex</span>
<span style="color: #689f38;">      domain that we can use to add a CNAME to</span>
<span style="color: #689f38;">      later.</span>
    <span style="color: #EF6C00;">Value</span>: <span style="color: #0097A7;">!GetAtt</span> CloudFront.DomainName
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgce5da4a" class="outline-2">
<h2 id="certificate"><a id="orgce5da4a"></a>Certificate</h2>
<div class="outline-text-2" id="text-certificate">
<p>
Next we create a <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-certificatemanager-certificate.html">Certificate</a>. It is fairly easy: the only required
configuration is the domain name. However, we will also add a
<code>SubjectAlternativeName</code> for the WWW sub-domain so we can use the same
cert for both. This goes in the <code>Resources</code> section:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>Creating AWS::CertificateManager::Certificate with SANs</label><pre><code class="src src-yaml" id="orgc500b4a"><span style="color: #EF6C00;">Resources</span>:
  <span style="color: #EF6C00;">SSL</span>:
    <span style="color: #EF6C00;">Type</span>: <span style="color: #689f38;">'AWS::CertificateManager::Certificate'</span>
    <span style="color: #EF6C00;">Properties</span>:
      <span style="color: #EF6C00;">DomainName</span>: <span style="color: #0097A7;">!Ref</span> DomainName
      <span style="color: #EF6C00;">SubjectAlternativeNames</span>:
        - <span style="color: #0097A7;">!Join</span> [<span style="color: #689f38;">'.'</span>, [<span style="color: #689f38;">'www'</span>, <span style="color: #0097A7;">!Ref</span> DomainName]]
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org940117d" class="outline-2">
<h2 id="s3-redirection"><a id="org940117d"></a>S3 Redirection bucket</h2>
<div class="outline-text-2" id="text-s3-redirection">
<p>
Next we create <code>ApexBucket</code>&#x2014;the bucket used for redirection from the
Apex domain to the WWW site proper. We'll use the <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-s3-bucket.html">AWS::S3::Bucket</a>
resource for that. <code>BucketName</code> is&#x2014;surprisingly, at least to me&#x2014;not
required, but I would like to specify it so I can find it in the S3
console later.
</p>

<p>
I <i>think</i> we just need the <code>RedirectAllRequestsTo</code> property, with its
<code>HostName</code> attribute. Furthermore the point of all this was to add SSL
so let's force <code>HTTPS</code> as the protocol, despite the fact that my site
doesn't support that <i>yet</i>. (It will before I make this configuration
active.) Here's how this section looks:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>S3 bucket for redirection</label><pre><code class="src src-yaml" id="org740ae52"><span style="color: #EF6C00;">Resources</span>:
  [...]
  <span style="color: #EF6C00;">ApexBucket</span>:
    <span style="color: #EF6C00;">Type</span>: <span style="color: #689f38;">'AWS::S3::Bucket'</span>
    <span style="color: #EF6C00;">Properties</span>:
      <span style="color: #EF6C00;">BucketName</span>: <span style="color: #0097A7;">!Ref</span> DomainName
      <span style="color: #EF6C00;">WebsiteConfiguration</span>:
        <span style="color: #EF6C00;">RedirectAllRequestsTo</span>:
          <span style="color: #EF6C00;">HostName</span>: <span style="color: #0097A7;">!Join</span> [<span style="color: #689f38;">'.'</span>, [<span style="color: #689f38;">'www'</span>, <span style="color: #0097A7;">!Ref</span> DomainName]]
          <span style="color: #EF6C00;">Protocol</span>: https
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgf584ec5" class="outline-2">
<h2 id="cloudfront"><a id="orgf584ec5"></a>CloudFront Distribution</h2>
<div class="outline-text-2" id="text-cloudfront">
<p>
Finally we need to set up the CloudFront distribution, using its
<a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cloudfront-distributionconfig.html">AWS::CloudFront::Distribution</a> resource. It has only one property, the
<code>DistributionConfig</code>, however, <i>its</i> attributes are numerous. Luckily all
are not required. Let's start with <code>Aliases</code>, which is our CNAME. This
is the name we <i>want</i> to assign later. It has to match the SSL
certificate we'll assign later.
</p>

<p>
We also have to set <code>Origins</code>, line <a href="#coderef-origins" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-origins');" onmouseout="CodeHighlightOff(this, 'coderef-origins');">10</a>. Rather than building the
DomainName for by <code>!Join</code>-ing strings I use the <code>WebsiteURL</code> attribute. It
wasn't as successful as I had hoped, since I have to <i>split</i> it to
separate the protocol from the domain name, as CloudFront wants only
the latter in its Origins section. One step forward, two steps back?
</p>

<p>
Moving swiftly on, the <a href="#coderef-customorigincfg" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-customorigincfg');" onmouseout="CodeHighlightOff(this, 'coderef-customorigincfg');">CustomOriginConfig</a><sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>, <a href="#coderef-defaultcache" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-defaultcache');" onmouseout="CodeHighlightOff(this, 'coderef-defaultcache');">DefaultCacheBehaviour</a>
and <a href="#coderef-viewercert" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-viewercert');" onmouseout="CodeHighlightOff(this, 'coderef-viewercert');">ViewerCertificate</a> sections I cribbed from a template my colleague
<a href="http://doismellburning.co.uk">Kristian Glass</a> provided as a reference point. I don't have much to say
about them, other than that they seem to do the job.
</p>

<div class="org-src-container">
<pre><code class="src src-yaml"><span class="linenr"> 1: </span><span style="color: #EF6C00;">Resources</span>:
<span class="linenr"> 2: </span>  [...]
<span class="linenr"> 3: </span>  <span style="color: #EF6C00;">ApexCloudFront</span>:
<span class="linenr"> 4: </span>    <span style="color: #EF6C00;">Type</span>: <span style="color: #689f38;">'AWS::CloudFront::Distribution'</span>
<span class="linenr"> 5: </span>    <span style="color: #EF6C00;">Properties</span>:
<span class="linenr"> 6: </span>      <span style="color: #EF6C00;">DistributionConfig</span>:
<span class="linenr"> 7: </span>        <span style="color: #EF6C00;">Aliases</span>:
<span class="linenr"> 8: </span>          - <span style="color: #0097A7;">!Ref</span> DomainName
<span class="linenr"> 9: </span>        <span style="color: #EF6C00;">Enabled</span>: <span style="color: #558b2f;">True</span>
<span id="coderef-origins" class="coderef-off"><span class="linenr">10: </span>        <span style="color: #EF6C00;">Origins</span>:</span>
<span class="linenr">11: </span>          - <span style="color: #EF6C00;">DomainName</span>: <span style="color: #0097A7;">!Select</span>
<span class="linenr">12: </span>              - 1
<span class="linenr">13: </span>              - <span style="color: #0097A7;">!Split</span> [<span style="color: #689f38;">"//"</span>, <span style="color: #0097A7;">!GetAtt</span> ApexBucket.WebsiteURL]
<span class="linenr">14: </span>            <span style="color: #EF6C00;">Id</span>: origin
<span id="coderef-customorigincfg" class="coderef-off"><span class="linenr">15: </span>            <span style="color: #EF6C00;">CustomOriginConfig</span>:</span>
<span class="linenr">16: </span>              <span style="color: #EF6C00;">OriginProtocolPolicy</span>: http-only
<span id="coderef-defaultcache" class="coderef-off"><span class="linenr">17: </span>        <span style="color: #EF6C00;">DefaultCacheBehavior</span>:</span>
<span class="linenr">18: </span>          <span style="color: #EF6C00;">TargetOriginId</span>: origin
<span class="linenr">19: </span>          <span style="color: #EF6C00;">DefaultTTL</span>: 5
<span class="linenr">20: </span>          <span style="color: #EF6C00;">MaxTTL</span>: 30
<span class="linenr">21: </span>          <span style="color: #EF6C00;">ForwardedValues</span>:
<span class="linenr">22: </span>            <span style="color: #EF6C00;">QueryString</span>: <span style="color: #558b2f;">false</span>
<span class="linenr">23: </span>          <span style="color: #EF6C00;">ViewerProtocolPolicy</span>: redirect-to-https
<span id="coderef-viewercert" class="coderef-off"><span class="linenr">24: </span>        <span style="color: #EF6C00;">ViewerCertificate</span>:</span>
<span class="linenr">25: </span>          <span style="color: #EF6C00;">AcmCertificateArn</span>: <span style="color: #0097A7;">!Ref</span> SSL
<span class="linenr">26: </span>          <span style="color: #EF6C00;">SslSupportMethod</span>: sni-only
</code></pre>
</div>
</div>

<div id="outline-container-org638d307" class="outline-3">
<h3 id="cloudfront-like-us-east-1"><a id="org638d307"></a>CloudFront <i>really</i> likes the <code>us-east-1</code> region</h3>
<div class="outline-text-3" id="text-cloudfront-like-us-east-1">
<p>
Attempting to create the above stack unfortunately fails with the
following error:
</p>

<pre class="example">
ApexCloudFront AWS::CloudFront::Distribution CREATE_FAILED The specified SSL certificate doesn't exist, isn't in us-east-1 region, isn't valid, or doesn't include a valid certificate chain.
</pre>

<p>
I would <i>prefer</i> to have the S3 bucket here in the UK where I am because
I believe it would make syncing my files to S3 faster. However,
CloudFormation cannot take input from stack output in other regions
and I don't want to have to manage <i>half</i> my setup in CloudFormation and
half outside, so I'll relent and move my stack to <code>us-east-1</code> to satisfy
CloudFront for now<sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup>.
</p>
</div>
</div>
</div>

<div id="outline-container-orgcd7afb3" class="outline-2">
<h2 id="testing-redirection"><a id="orgcd7afb3"></a>Testing that redirection works</h2>
<div class="outline-text-2" id="text-testing-redirection">
<p>
Now that I'm using <code>us-east-1</code> as the region creating the stack
succeeds. But does it <i>work</i>? Since I haven't delegated DNS yet I have
to use the CloudFormation distribution URL directly to test it:
</p>

<div class="org-src-container">
<pre><code class="src src-sh">curl -v http://superloopy.io.s3-website-us-east-1.amazonaws.com/articles/2017/adding-ssl.html
</code></pre>
</div>

<pre class="example">
[...]
&lt; HTTP/1.1 301 Moved Permanently
[...]
&lt; Location: https://www.superloopy.io/articles/2017/adding-ssl.html
</pre>

<p>
So, yes! The S3 setup looks like it's working! But&#x2026; Does the
CloudFront setup work? This is where the <code>Outputs</code> section comes in&#x2014;I
can ask Sceptre to display my stack's outputs:
</p>

<div class="org-src-container">
<pre><code class="src src-sh">sceptre describe-stack-outputs superloopy www
</code></pre>
</div>

<pre class="example">
- Description: The CloudFront domain name that we can add a CNAME to later.
  OutputKey: Hostname
  OutputValue: d117yhymq9s8zd.cloudfront.net

</pre>

<p>
Plugging that domain name into my query results in:
</p>

<div class="org-src-container">
<pre><code class="src src-sh">curl -v https://d117yhymq9s8zd.cloudfront.net/articles/2017/adding-ssl.html
</code></pre>
</div>

<pre class="example">
[...]
&lt; HTTP/1.1 301 Moved Permanently
[...]
&lt; Location: https://www.superloopy.io/articles/2017/adding-ssl.html
</pre>

<p>
Result!
</p>
</div>
</div>

<div id="outline-container-org0a4472e" class="outline-2">
<h2 id="complete-template"><a id="org0a4472e"></a>The completed template</h2>
<div class="outline-text-2" id="text-complete-template">
<p>
For the sake of completeness, here's my completed template:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>Complete <code>templates/www.yaml</code> template</label><pre><code class="src src-yaml" id="org5099ac7"><span style="color: #EF6C00;">AWSTemplateFormatVersion</span>: <span style="color: #689f38;">"2010-09-09"</span>
<span style="color: #EF6C00;">Parameters</span>:
  <span style="color: #EF6C00;">DomainName</span>:
    <span style="color: #EF6C00;">Type</span>: String
    <span style="color: #EF6C00;">Default</span>: example.net
<span style="color: #EF6C00;">Outputs</span>:
  <span style="color: #EF6C00;">ApexCloudFrontDomain</span>:
    <span style="color: #EF6C00;">Description</span>: &gt;-
      <span style="color: #689f38;">The CloudFront domain name for the Apex</span>
<span style="color: #689f38;">      domain that we can use to add a CNAME to</span>
<span style="color: #689f38;">      later.</span>
    <span style="color: #EF6C00;">Value</span>: <span style="color: #0097A7;">!GetAtt</span> ApexCloudFront.DomainName
<span style="color: #EF6C00;">Resources</span>:
  <span style="color: #EF6C00;">SSL</span>:
    <span style="color: #EF6C00;">Type</span>: <span style="color: #689f38;">'AWS::CertificateManager::Certificate'</span>
    <span style="color: #EF6C00;">Properties</span>:
      <span style="color: #EF6C00;">DomainName</span>: <span style="color: #0097A7;">!Ref</span> DomainName
      <span style="color: #EF6C00;">SubjectAlternativeNames</span>:
        - <span style="color: #0097A7;">!Join</span> [<span style="color: #689f38;">'.'</span>, [<span style="color: #689f38;">'www'</span>, <span style="color: #0097A7;">!Ref</span> DomainName]]
  <span style="color: #EF6C00;">ApexBucket</span>:
    <span style="color: #EF6C00;">Type</span>: <span style="color: #689f38;">'AWS::S3::Bucket'</span>
    <span style="color: #EF6C00;">Properties</span>:
      <span style="color: #EF6C00;">BucketName</span>: <span style="color: #0097A7;">!Ref</span> DomainName
      <span style="color: #EF6C00;">WebsiteConfiguration</span>:
        <span style="color: #EF6C00;">RedirectAllRequestsTo</span>:
          <span style="color: #EF6C00;">HostName</span>: <span style="color: #0097A7;">!Join</span> [<span style="color: #689f38;">'.'</span>, [<span style="color: #689f38;">'www'</span>, <span style="color: #0097A7;">!Ref</span> DomainName]]
          <span style="color: #EF6C00;">Protocol</span>: https
  <span style="color: #EF6C00;">ApexCloudFront</span>:
    <span style="color: #EF6C00;">Type</span>: <span style="color: #689f38;">'AWS::CloudFront::Distribution'</span>
    <span style="color: #EF6C00;">Properties</span>:
      <span style="color: #EF6C00;">DistributionConfig</span>:
        <span style="color: #EF6C00;">Aliases</span>:
          - <span style="color: #0097A7;">!Ref</span> DomainName
        <span style="color: #EF6C00;">Enabled</span>: <span style="color: #558b2f;">True</span>
        <span style="color: #EF6C00;">Origins</span>:
          - <span style="color: #EF6C00;">DomainName</span>: <span style="color: #0097A7;">!Select</span>
              - 1
              - <span style="color: #0097A7;">!Split</span> [<span style="color: #689f38;">"//"</span>, <span style="color: #0097A7;">!GetAtt</span> ApexBucket.WebsiteURL]
            <span style="color: #EF6C00;">Id</span>: origin
            <span style="color: #EF6C00;">CustomOriginConfig</span>:
              <span style="color: #EF6C00;">OriginProtocolPolicy</span>: http-only
        <span style="color: #EF6C00;">DefaultCacheBehavior</span>:
          <span style="color: #EF6C00;">TargetOriginId</span>: origin
          <span style="color: #EF6C00;">DefaultTTL</span>: 5
          <span style="color: #EF6C00;">MaxTTL</span>: 30
          <span style="color: #EF6C00;">ForwardedValues</span>:
            <span style="color: #EF6C00;">QueryString</span>: <span style="color: #558b2f;">false</span>
          <span style="color: #EF6C00;">ViewerProtocolPolicy</span>: redirect-to-https
        <span style="color: #EF6C00;">ViewerCertificate</span>:
          <span style="color: #EF6C00;">AcmCertificateArn</span>: <span style="color: #0097A7;">!Ref</span> SSL
          <span style="color: #EF6C00;">SslSupportMethod</span>: sni-only
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org6764783" class="outline-2">
<h2 id="conclusion"><a id="org6764783"></a>Conclusion</h2>
<div class="outline-text-2" id="text-conclusion">
<p>
I am pretty happy with this setup. No doubt it will be useful when
moving all my sites to HTTPS over the next months.
</p>
</div>
</div>
<div id="footnotes"><!--Footnotes-->
<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
For a while I felt that I should be using an <code>S3OriginConfig</code>
instead, but I didn't feel this was very well documented and I
couldn't manage to get that to work. A bit of reading implied that it
requires a <a href="http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/private-content-restricting-access-to-s3.html">Origin Access Identity</a> that cannot be created / added using
CloudFormation so I decided to just stick with the <code>CustomOriginConfig</code>
instead. It's not like my S3 bucket's content is secret. I <i>also</i> got
the impression that going that route means you don't get to benefit
from the "website hosting bucket" properties, which means no
<code>RedirectAllRequestsTo</code> and no <code>CustomErrorDocument</code> and no <code>IndexDocument</code>
properties.
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara">Hopefully in the future CloudFront allows certs
made anywhere, and then I can re-create my stack in a region closer to
home.</div></div>

</div></div>
<div id="postamble" class="status">
<p class="date">Date: 21 July 2017</p>
<p class="author">Author: Stig Brautaset</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
