<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Managing AWS Route 53 with CloudFormation</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Stig Brautaset">
<link rel="stylesheet" type="text/css" href="/css/main.css" />
<link rel="icon" type="image/png" href="/images/icon.png" />
<script type="text/javascript">
if(/superloopy.io/.test(window.location.hostname)) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-4113456-6', 'auto');
  ga('send', 'pageview');
}
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>

<div id="org-div-home-and-up">
  <a href="/"><img src="/images/logo.png" alt="Superloopy Logo"/></a>
  <nav>
    <ul>
      <li><a accesskey="H" href="/"> Home </a></li>
      <li><a accesskey="p" href="/publications.html"> Publications </a></li>
      <li><a accesskey="A" href="/about.html"> About </a></li>
      <li><a accesskey="c" href="/contact.html"> Contact </a></li>
      <li>Licence: <a accesskey="l" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a></li>
    </ul>
  </nav>
</div>
<div id="content">
<h1 class="title">Managing AWS Route 53 with CloudFormation</h1>
<div class="abstract">
<p>
In which I delegate DNS from Gandi to AWS Route 53, and learn how to
configure Route 53 with CloudFormation &amp; Sceptre.
</p>

</div>

<div id="outline-container-org8a8616f" class="outline-2">
<h2 id="org8a8616f">Introduction</h2>
<div class="outline-text-2" id="text-org8a8616f">
<p>
In my <a href="adding-ssl.html">previous post</a> I outlined my plan for adding SSL to this blog.
This post is me exploring the first step in that plan: managing DNS in
AWS Route 53 via CloudFormation.
</p>

<p>
Gandi has been great for the most part but using their DNS
configuration is my least favourite part of interacting with their
site. Route 53 is a lot less frustrating, but I've got the exact same
base DNS setup I want to replicate across at least three domains that
I own and I don't want to do it all manually. Also, I want to learn
more about CloudFormation.
</p>

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org8a8616f">Introduction</a></li>
<li><a href="#org3858226">Discussion</a></li>
<li><a href="#orgd10e56b">Creating a Route53 HostedZone with CloudFormation</a></li>
<li><a href="#org327830e">Setting up Route 53 MX records with CloudFormation</a></li>
<li><a href="#orgce560f0">Combining the zone and mx stacks</a></li>
<li><a href="#org129529d">Conclusion</a></li>
</ul>
</div>
</div>
<div id="list-of-listings">
<h2>List of Listings</h2>
<div id="text-list-of-listings">
<ul>
<li><a href="#orgb19ce90"><span class="listing-number">Listing 1:</span> <code>templates/dns-zone.yaml</code></a></li>
<li><a href="#org70618ab"><span class="listing-number">Listing 2:</span> <code>config/superloopy/dns-zone.yaml</code></a></li>
<li><a href="#orgb781fd9"><span class="listing-number">Listing 3:</span> <code>templates/mx.yaml</code></a></li>
<li><a href="#org82ddc19"><span class="listing-number">Listing 4:</span> <code>config/superloopy/mx.yaml</code></a></li>
<li><a href="#org3c73d39"><span class="listing-number">Listing 5:</span> <code>templates/dns.yaml</code></a></li>
<li><a href="#org680fb1b"><span class="listing-number">Listing 6:</span> <code>config/superloopy/dns.yaml</code></a></li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org3858226" class="outline-2">
<h2 id="org3858226">Discussion</h2>
<div class="outline-text-2" id="text-org3858226">
<p>
I started this journey by reading through the <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/Welcome.html">CloudFormation User
Guide</a>. It is alright at explaining how the various bits in the
templates fit together, but I feel there's a bit missing with regards
to application. They are very firm in their recommendation that you
should put your templates in revision control, but they don't really
show any techniques for how you would go about that. They mostly use
the AWS console for interacting with CloudFormation which I do not
want to do.
</p>

<p>
Enter <a href="https://sceptre.cloudreach.com/latest/about.html">Sceptre</a>, an unopinionated tool to drive CloudFormation. Its
<a href="https://sceptre.cloudreach.com/latest/docs/get_started.html">Getting Started Guide</a> starts out by explaining the directory layout
and config files involved, and is a good companion to the
CloudFormation docs in my opinion.
</p>
</div>
</div>

<div id="outline-container-orgd10e56b" class="outline-2">
<h2 id="orgd10e56b">Creating a Route53 HostedZone with CloudFormation</h2>
<div class="outline-text-2" id="text-orgd10e56b">
<p>
To manage Route 53 records with CloudFormation you need to use a
<code>AWS::Route53::RecordSet</code>. One of <i>its</i> required properties is a
<code>HostedZone</code> (or <code>HostedZoneName</code>) property&#x2014;so I started there. Turns
out creating a zone is very easy. My complete template (stored in
<code>templates/dns-zone.yaml</code>) looks like this:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span><code>templates/dns-zone.yaml</code></label><pre><code class="src src-yaml" id="orgb19ce90"><span style="color: #EF6C00;">AWSTemplateFormatVersion</span>: <span style="color: #689f38;">"2010-09-09"</span>
<span style="color: #EF6C00;">Parameters</span>:
  <span style="color: #EF6C00;">DomainName</span>:
    <span style="color: #EF6C00;">Type</span>: String
    <span style="color: #EF6C00;">Default</span>: example.net
<span style="color: #EF6C00;">Resources</span>:
  <span style="color: #EF6C00;">DNS</span>:
    <span style="color: #EF6C00;">Type</span>: <span style="color: #689f38;">"AWS::Route53::HostedZone"</span>
    <span style="color: #EF6C00;">Properties</span>:
      <span style="color: #EF6C00;">Name</span>: <span style="color: #0097A7;">!Ref</span> DomainName
      <span style="color: #EF6C00;">HostedZoneConfig</span>:
        <span style="color: #EF6C00;">Comment</span>: <span style="color: #0097A7;">!Join</span>
          - <span style="color: #689f38;">" "</span>
          - [<span style="color: #689f38;">"My hosted zone for"</span>, <span style="color: #0097A7;">!Ref</span> DomainName]
</code></pre>
</div>

<p>
I set up a single required parameter, the domain name we want to
create a zone for, and create a single resource of type. The only
thing that caused me a bit of trouble here was getting the <code>!Join</code>
syntax right for the comment.
</p>

<p>
With a template in place we need an environment &amp; stack config so we
can create a stack. Normally an "environment" is something like "dev",
"test", "prod" but I won't bother with that for my blog so I'll use
"superloopy" for the environment name for this blog here at
<a href="http://www.superloopy.io">superloopy.io</a>. I create a file called <code>config/superloopy/dns-zone.yaml</code>
that looks like this:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span><code>config/superloopy/dns-zone.yaml</code></label><pre><code class="src src-yaml" id="org70618ab"><span style="color: #EF6C00;">template_path</span>: templates/dns-zone.yaml
<span style="color: #EF6C00;">parameters</span>:
    <span style="color: #EF6C00;">DomainName</span>: superloopy.io
</code></pre>
</div>

<p>
Now we're ready to run Sceptre! Note: I don't worry about breaking my
blog at this point because I haven't yet told Gandi to use AWS' name
servers. I execute sceptre from the top-level directory like so:
</p>

<div class="org-src-container">
<pre><code class="src src-fish"><span style="color: #B71C1C;">sceptre</span> create-stack superloopy dns-zone
</code></pre>
</div>

<p>
Here's the result of running that command, with timestamps &amp; common
prefixes removed:
</p>

<pre class="example">
Creating stack
sb-superloopy-dns-zone AWS::CloudFormation::Stack CREATE_IN_PROGRESS User Initiated
DNS AWS::Route53::HostedZone CREATE_IN_PROGRESS
DNS AWS::Route53::HostedZone CREATE_IN_PROGRESS Resource creation Initiated
DNS AWS::Route53::HostedZone CREATE_COMPLETE
sb-superloopy-dns-zone AWS::CloudFormation::Stack CREATE_COMPLETE

</pre>

<p>
Success! Next I thought I'd tackle my MX setup.
</p>
</div>
</div>

<div id="outline-container-org327830e" class="outline-2">
<h2 id="org327830e">Setting up Route 53 MX records with CloudFormation</h2>
<div class="outline-text-2" id="text-org327830e">
<p>
I use Gandi's MXs and see no need to end that now. There's a primary
and a secondary, with different priorities and domain names. After a
bit of experimentation I ended up with <code>templates/mx.yaml</code> looking like
this:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span><code>templates/mx.yaml</code></label><pre><code class="src src-yaml" id="orgb781fd9"><span style="color: #EF6C00;">AWSTemplateFormatVersion</span>: <span style="color: #689f38;">"2010-09-09"</span>
<span style="color: #EF6C00;">Parameters</span>:
  <span style="color: #EF6C00;">DomainName</span>:
    <span style="color: #EF6C00;">Type</span>: String
    <span style="color: #EF6C00;">Default</span>: example.net
  <span style="color: #EF6C00;">PrimaryMx</span>:
    <span style="color: #EF6C00;">Type</span>: String
    <span style="color: #EF6C00;">Default</span>: spool.mail.gandi.net
  <span style="color: #EF6C00;">SecondaryMx</span>:
    <span style="color: #EF6C00;">Type</span>: String
    <span style="color: #EF6C00;">Default</span>: fb.mail.gandi.net
  <span style="color: #EF6C00;">TTL</span>:
    <span style="color: #EF6C00;">Type</span>: Number
    <span style="color: #EF6C00;">Default</span>: 600
<span style="color: #EF6C00;">Resources</span>:
  <span style="color: #EF6C00;">MxRecordSet</span>:
    <span style="color: #EF6C00;">Type</span>: AWS::Route53::RecordSet
    <span style="color: #EF6C00;">Properties</span>:
      <span style="color: #EF6C00;">Name</span>: <span style="color: #0097A7;">!Ref</span> DomainName
      <span style="color: #EF6C00;">HostedZoneName</span>: <span style="color: #0097A7;">!Join</span>
        - <span style="color: #689f38;">""</span>
        - [<span style="color: #0097A7;">!Ref</span> DomainName, <span style="color: #689f38;">"."</span>]
      <span style="color: #EF6C00;">Type</span>: MX
      <span style="color: #EF6C00;">TTL</span>: <span style="color: #0097A7;">!Ref</span> TTL
      <span style="color: #EF6C00;">ResourceRecords</span>:
        - <span style="color: #0097A7;">!Join</span>
          - <span style="color: #689f38;">""</span>
          - [10, <span style="color: #689f38;">" "</span>, <span style="color: #0097A7;">!Ref</span> PrimaryMx, <span style="color: #689f38;">"."</span>]
        - <span style="color: #0097A7;">!Join</span>
          - <span style="color: #689f38;">""</span>
          - [50, <span style="color: #689f38;">" "</span>, <span style="color: #0097A7;">!Ref</span> SecondaryMx, <span style="color: #689f38;">"."</span>]
</code></pre>
</div>

<p>
I'm not terribly happy with the hardcoded priorities for the MX
servers, nor with the limitation that the template only supports two
MXs. (Nor, indeed, that it <i>requires</i> two MXs.) But&#x2014;it will suffice
for now.
</p>

<p>
When it comes to the stack config the default MXs are fine for my
domain, so all we need to set in the stack config is the <code>DomainName</code>:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span><code>config/superloopy/mx.yaml</code></label><pre><code class="src src-yaml" id="org82ddc19"><span style="color: #EF6C00;">template_path</span>: templates/mx.yaml
<span style="color: #EF6C00;">parameters</span>:
  <span style="color: #EF6C00;">DomainName</span>: superloopy.io
</code></pre>
</div>

<p>
Standing up that stack looks like this (minus the timestamps etc):
</p>

<pre class="example">
superloopy/mx - Creating stack
sb-superloopy-mx AWS::CloudFormation::Stack CREATE_IN_PROGRESS User Initiated
MxRecordSet AWS::Route53::RecordSet CREATE_IN_PROGRESS
MxRecordSet AWS::Route53::RecordSet CREATE_IN_PROGRESS Resource creation Initiated
MxRecordSet AWS::Route53::RecordSet CREATE_COMPLETE
sb-superloopy-mx AWS::CloudFormation::Stack CREATE_COMPLETE

</pre>

<p>
If I ask one of the AWS nameservers listed in my zone, I can see that
the MX record looks alright. I have to add the address of the NS to
query part to explicitly ask one of the AWS nameserves as I have not
yet delegated the zone to AWS.
</p>

<div class="org-src-container">
<pre><code class="src src-fish"><span style="color: #B71C1C;">dig</span> @ns-1681.awsdns-18.co.uk -t mx superloopy.io +short
</code></pre>
</div>

<pre class="example">
10 spool.mail.gandi.net.
50 fb.mail.gandi.net.

</pre>

<p>
Great!
</p>
</div>
</div>

<div id="outline-container-orgce560f0" class="outline-2">
<h2 id="orgce560f0">Combining the zone and mx stacks</h2>
<div class="outline-text-2" id="text-orgce560f0">
<p>
At this point I started having second thoughts about my approach. I
originally had in mind setting up just the zone in one stack, and
creating the mx entries as another stack, and the Apex forwarding with
its own DNS Setup in a separate stack, and finally the www bucket with
the content with its own DNS setup in yet another stack.
</p>

<p>
However, I think I got it the wrong way around. I now feel that all
the DNS setup should be in one stack. I combined my <code>dns-zone</code> and <code>mx</code>
templates into a single template and added handling of the Apex and
WWW records to it. The resulting template is in <code>templates/dns.yaml</code> and
its contents is:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span><code>templates/dns.yaml</code></label><pre><code class="src src-yaml" id="org3c73d39"><span style="color: #EF6C00;">AWSTemplateFormatVersion</span>: <span style="color: #689f38;">"2010-09-09"</span>
<span style="color: #EF6C00;">Parameters</span>:
  <span style="color: #EF6C00;">DomainName</span>:
    <span style="color: #EF6C00;">Type</span>: String
    <span style="color: #EF6C00;">Default</span>: example.net
  <span style="color: #EF6C00;">TTL</span>:
    <span style="color: #EF6C00;">Type</span>: Number
    <span style="color: #EF6C00;">Default</span>: 600
  <span style="color: #EF6C00;">MxRecords</span>:
    <span style="color: #EF6C00;">Type</span>: CommaDelimitedList
    <span style="color: #EF6C00;">Description</span>: &gt;-
      <span style="color: #689f38;">A comma-separated list of entries for MX servers. Each entry</span>
<span style="color: #689f38;">      should have a priority and domain name, separated by a space.</span>
    <span style="color: #EF6C00;">Default</span>: 10 spool.mail.gandi.net,50 fb.mail.gandi.net
  <span style="color: #EF6C00;">ApexRecords</span>:
    <span style="color: #EF6C00;">Type</span>: CommaDelimitedList
    <span style="color: #EF6C00;">Description</span>: &gt;-
      <span style="color: #689f38;">The default here is for GitHub Pages, cf</span>
<span style="color: #689f38;">      https://help.github.com/articles/setting-up-an-apex-domain/</span>
    <span style="color: #EF6C00;">Default</span>: 192.30.252.153,192.30.252.154
  <span style="color: #EF6C00;">WwwRecord</span>:
    <span style="color: #EF6C00;">Type</span>: String
    <span style="color: #EF6C00;">Description</span>: &gt;-
      <span style="color: #689f38;">Set up www.example.net as CNAME for this address</span>
    <span style="color: #EF6C00;">Default</span>: stig.github.io
<span style="color: #EF6C00;">Resources</span>:
  <span style="color: #EF6C00;">Zone</span>:
    <span style="color: #EF6C00;">Type</span>: <span style="color: #689f38;">'AWS::Route53::HostedZone'</span>
    <span style="color: #EF6C00;">Properties</span>:
      <span style="color: #EF6C00;">Name</span>: <span style="color: #0097A7;">!Ref</span> DomainName
      <span style="color: #EF6C00;">HostedZoneConfig</span>:
        <span style="color: #EF6C00;">Comment</span>: <span style="color: #0097A7;">!Join</span>
          - <span style="color: #689f38;">" "</span>
          - [<span style="color: #689f38;">"My hosted zone for"</span>, <span style="color: #0097A7;">!Ref</span> DomainName]
  <span style="color: #EF6C00;">MxRecordSet</span>:
    <span style="color: #EF6C00;">Type</span>: <span style="color: #689f38;">'AWS::Route53::RecordSet'</span>
    <span style="color: #EF6C00;">Properties</span>:
      <span style="color: #EF6C00;">Name</span>: <span style="color: #0097A7;">!Ref</span> DomainName
      <span style="color: #EF6C00;">HostedZoneId</span>: <span style="color: #0097A7;">!Ref</span> Zone
      <span style="color: #EF6C00;">Type</span>: MX
      <span style="color: #EF6C00;">TTL</span>: <span style="color: #0097A7;">!Ref</span> TTL
      <span style="color: #EF6C00;">ResourceRecords</span>: <span style="color: #0097A7;">!Ref</span> MxRecords
  <span style="color: #EF6C00;">ApexRecordSet</span>:
    <span style="color: #EF6C00;">Type</span>: <span style="color: #689f38;">'AWS::Route53::RecordSet'</span>
    <span style="color: #EF6C00;">Properties</span>:
      <span style="color: #EF6C00;">Name</span>: <span style="color: #0097A7;">!Ref</span> DomainName
      <span style="color: #EF6C00;">HostedZoneId</span>: <span style="color: #0097A7;">!Ref</span> Zone
      <span style="color: #EF6C00;">Type</span>: A
      <span style="color: #EF6C00;">TTL</span>: <span style="color: #0097A7;">!Ref</span> TTL
      <span style="color: #EF6C00;">ResourceRecords</span>: <span style="color: #0097A7;">!Ref</span> ApexRecords
  <span style="color: #EF6C00;">WwwRecordSet</span>:
    <span style="color: #EF6C00;">Type</span>: <span style="color: #689f38;">'AWS::Route53::RecordSet'</span>
    <span style="color: #EF6C00;">Properties</span>:
      <span style="color: #EF6C00;">Name</span>: <span style="color: #0097A7;">!Join</span>
        - <span style="color: #689f38;">""</span>
        - [<span style="color: #689f38;">'www.'</span>, <span style="color: #0097A7;">!Ref</span> DomainName, <span style="color: #689f38;">'.'</span>]
      <span style="color: #EF6C00;">HostedZoneId</span>: <span style="color: #0097A7;">!Ref</span> Zone
      <span style="color: #EF6C00;">Type</span>: CNAME
      <span style="color: #EF6C00;">TTL</span>: <span style="color: #0097A7;">!Ref</span> TTL
      <span style="color: #EF6C00;">ResourceRecords</span>:
        - <span style="color: #0097A7;">!Ref</span> WwwRecord
</code></pre>
</div>

<p>
As you can see from Listing <a href="#org3c73d39">5</a> I also switched to using a
<code>CommaDelimitedList</code> for the MX records. (I learnt about them when
researching how to best represent the <code>ApexRecords</code>.) So, now we don't
hard-code priorities in the template, and we support any number of MX
records.
</p>

<p>
Finally we just need a new <code>config/superloopy/dns.yaml</code> file to drive
it, and since the defaults are mostly OK it just needs to set the
template path and DomainName:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span><code>config/superloopy/dns.yaml</code></label><pre><code class="src src-yaml" id="org680fb1b"><span style="color: #EF6C00;">template_path</span>: templates/dns.yaml
<span style="color: #EF6C00;">parameters</span>:
  <span style="color: #EF6C00;">DomainName</span>: superloopy.io
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org129529d" class="outline-2">
<h2 id="org129529d">Conclusion</h2>
<div class="outline-text-2" id="text-org129529d">
<p>
So, that's it for this post. I've learnt how to set up a Route 53 zone
with Sceptre/CloudFormation and I'm pretty happy with it. I haven't
actually delegated DNS to this zone yet, as I want to give myself a
chance to experiment a bit more figuring out how to change this DNS
zone to refer to CloudFront distributions while I learn how to set up
the redirections for the Apex domain and hosting www from an S3 bucket
behind CloudFront.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 19 July 2017</p>
<p class="author">Author: Stig Brautaset</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
