<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Hydra Theme Switcher for Emacs</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Stig Brautaset">
<link rel="stylesheet" type="text/css" href="/css/main.css" />
<link rel="icon" type="image/png" href="/images/icon.png" />
<script type="text/javascript">
if(/superloopy.io/.test(window.location.hostname)) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-4113456-6', 'auto');
  ga('send', 'pageview');
}
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>

<div id="org-div-home-and-up">
  <img src="/images/logo.png" alt="Superloopy Logo"/>
  <nav>
    <ul>
      <li><a accesskey="H" href="/"> Home </a></li>
      <li><a accesskey="p" href="/publications.html"> Publications </a></li>
      <li><a accesskey="A" href="/about.html"> About </a></li>
      <li><a accesskey="c" href="/contact.html"> Contact </a></li>
    </ul>
  </nav>
</div>
<div id="content">
<h1 class="title">Hydra Theme Switcher for Emacs</h1>
<div class="abstract">
<p>
I learnt how to quickly switch between all installed themes in Emacs
using Hydra.
</p>

</div>
<p>
I recently read Greg Hendershott's <a href="http://www.greghendershott.com/2017/02/emacs-themes.html">emacs themes</a> blog post, and cribbed
liberally from his approach to loading themes. I also cribbed his
Hydra theme switcher. It was so fun to use! I wanted to try it with
all the themes I have installed&#x2014;but I didn't want to add all of them
manually. Boo! So I set out to see if I could dynamically add all
installed themes to my Hydra theme switcher.
</p>

<p>
First I needed a list of all installed themes. I remembered that when
you do <code>M-x load-theme RET</code> and TAB you get a list of all the themes,
so I started looking there. <code>C-h f load-theme RET</code> brings up the
documentation for that function, and this has a link to the source at
the top. I clicked that, and quickly found that it calls
<code>custom-available-themes</code>.
</p>

<p>
Next I needed to generate the Hydra docstring/menu. My biggest
annoyance with the manual process was modifying the docstring to add
the key &amp; hint. So initially I thought about automating this in some
way, perhaps by listing light &amp; dark &amp; "other" themes separately. But
it would still be annoying. I thought about chaining hydras too, but
then I discovered that Hydra supports a different mode: you can
provide a hint as the third argument in the "head" and it will create
the menu for you. I opted for this approach.
</p>

<p>
I now needed to come up with a strategy for how to select KEYs to
select each theme. First I thought about using mnemonics for the
themes themselves, but I have both <code>leuven</code>, <code>leuven-dark</code>,
<code>light-blue</code>, and <code>liso</code> all starting with <code>l</code>. I then thought about
using shortest unique substring, but that would mean variable-length
keys which I didn't want; as much as possible I wanted
single-keystroke keys. So I decided to go with an alphabet of 62
candidate keys:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #00796b;">setq</span> sb/hydra-selectors
     <span style="color: #689f38;">"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>)
</pre>
</div>

<p>
The list returned by <code>custom-available-themes</code> is not sorted
alphabetically, but I wanted my Hydra menu to present them that way.
It took a while to figure out how to sort the list since it's a list
of symbols rather than strings, and also I spent a long time hunting
for non-destructive sort. (I didn't find any, but it turns out the
list is created every time so it's not necessary.) My theme sorter
looks like this:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #00796b;">defun</span> <span style="color: #0097A7;">sb/sort-themes</span> (themes)
  (sort themes
        (<span style="color: #00796b;">lambda</span> (a b)
          (string&lt; (symbol-name a) 
                   (symbol-name b)))))
</pre>
</div>

<p>
Now I was ready create my Hydra's "heads". These should be of the
form <code>(KEY ACTION HINT)</code>. I had a list of candidate KEYs, and a list
of themes to build the action and hint, but I needed to piece it
together. I struggled to figure out how to correlate the KEY and THEME
using <code>mapcar</code>, but then I noticed <code>mapcar*</code> (final <code>*</code> is
significant) among the autocomplete candidates. This is very similar
to <code>mapcar</code> but takes multiple lists and passes a value from each to
the mapping function. Just what I needed! As a bonus it stops when
<i>either</i> list runs out of items.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #00796b;">defun</span> <span style="color: #0097A7;">sb/hydra-load-theme-heads</span> (themes)
  (mapcar* (<span style="color: #00796b;">lambda</span> (a b)
             (list (char-to-string a)
                   `(sb/load-theme ',b)
                   (symbol-name b)))
           sb/hydra-selectors themes))
</pre>
</div>

<p>
The <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Backquote.html#Backquote">backquote</a> (<code>`</code>) in that snippet is similar to quoting with <code>'</code> or
<code>quote</code>, but allows you to selectively <i>unquote</i> bits inside with <code>,</code>.
I need it because I needed to quote the argument to <code>sb/load-theme</code>.
</p>

<p>
<code>defhydra</code> doesn't take a list of heads, but I thought I might find a
related function that would, perhaps <code>defhydra*</code>. Unfortunately, I had
no such luck. However, this is Lisp so there are ways. We'll reach for
backquote again, but this time instead of a simple unquote we <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Backquote.html#Backquote">splice</a>
our heads into the <code>defhydra</code> argument list with <code>,@</code>. This now looked
like so:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(eval `(<span style="color: #00796b;">defhydra</span> sb/hydra-select-themes
         (<span style="color: #B71C1C;">:hint</span> nil <span style="color: #B71C1C;">:color</span> pink)
         <span style="color: #689f38;">"Select Theme"</span>
         ,@(sb/hydra-load-theme-heads
            (sb/sort-themes
             (custom-available-themes)))
         (<span style="color: #689f38;">"DEL"</span> (sb/disable-all-themes))
         (<span style="color: #689f38;">"RET"</span> nil <span style="color: #689f38;">"done"</span> <span style="color: #B71C1C;">:color</span> blue)))
</pre>
</div>

<p>
We then just need to assign a keybinding, which I do like this:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #00796b;">bind-keys</span> (<span style="color: #689f38;">"C-c w t"</span> . sb/hydra-select-themes/body))
</pre>
</div>

<p>
This worked beautifully, except for one issue: if I installed a new
theme it would not show up in my Hydra menu until I manually
re-evaluated the config snippet, or restart Emacs. That's not ideal.
Perusing the Hydra examples revealed <a href="https://github.com/abo-abo/hydra/wiki/Switch-to-buffer">a recipe that assigned the return
value of <code>defhydra</code></a> to the key, so next I tried to rewrite my code to
this:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #00796b;">bind-keys</span> (<span style="color: #689f38;">"C-c w t"</span> .
            (eval `(<span style="color: #00796b;">defhydra</span> sb/hydra-select-themes
                     (<span style="color: #B71C1C;">:hint</span> nil <span style="color: #B71C1C;">:color</span> pink)
                     <span style="color: #689f38;">"Select Theme"</span>
                     ,@(sb/hydra-load-theme-heads
                        (sb/sort-themes
                         (custom-available-themes)))
                     (<span style="color: #689f38;">"DEL"</span> (sb/disable-all-themes))
                     (<span style="color: #689f38;">"RET"</span> nil <span style="color: #689f38;">"done"</span> <span style="color: #B71C1C;">:color</span> blue)))))
</pre>
</div>

<p>
Unfortunately that did not work. Launching the Hydra now I got the
following error:
</p>

<blockquote>
<p>
command-execute: Wrong type argument: commandp, (eval (\` (defhydra sb/hydra-select-themes (:hint nil :color pink) "Select Theme" (\,@ (sb/hydra-load-theme-heads (sb/sort-themes (custom-available-themes)))) ("DEL" (sb/disable-all-themes)) ("RET" nil "done" :color blue))))
</p>
</blockquote>

<p>
I didn't really understand what that meant, but I searched the hydra
issues some more for "dynamic" invocation and found <a href="https://github.com/abo-abo/hydra/issues/137#issuecomment-117132873">a comment</a> with a
recipe that I was able to adapt. It's a bit more faff, and I don't
understand why the <code>call-interactively</code> is necessary, but it works and
here it is:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #00796b;">bind-keys</span> (<span style="color: #689f38;">"C-c w t"</span> .
            (<span style="color: #00796b;">lambda</span> ()
              (<span style="color: #00796b;">interactive</span>)
              (call-interactively
               (eval `(<span style="color: #00796b;">defhydra</span> sb/hydra-select-themes
                        (<span style="color: #B71C1C;">:hint</span> nil <span style="color: #B71C1C;">:color</span> pink)
                        <span style="color: #689f38;">"Select Theme"</span>
                        ,@(sb/hydra-load-theme-heads
                           (sb/sort-themes
                            (custom-available-themes)))
                        (<span style="color: #689f38;">"DEL"</span> (sb/disable-all-themes))
                        (<span style="color: #689f38;">"RET"</span> nil <span style="color: #689f38;">"done"</span> <span style="color: #B71C1C;">:color</span> blue)))))))
</pre>
</div>

<p>
For completeness here's the full source for this switcher:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #00796b;">defun</span> <span style="color: #0097A7;">sb/disable-all-themes</span> ()
  (<span style="color: #00796b;">interactive</span>)
  (mapc #'disable-theme custom-enabled-themes))

(<span style="color: #00796b;">defun</span> <span style="color: #0097A7;">sb/load-theme</span> (theme)
  <span style="color: #673ab7;">"Enhance `</span><span style="color: #558b2f;">load-theme</span><span style="color: #673ab7;">' by first disabling enabled themes."</span>
  (sb/disable-all-themes)
  (load-theme theme))

(<span style="color: #00796b;">setq</span> sb/hydra-selectors
      <span style="color: #689f38;">"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>)

(<span style="color: #00796b;">defun</span> <span style="color: #0097A7;">sb/sort-themes</span> (themes)
  (sort themes
        (<span style="color: #00796b;">lambda</span> (a b)
          (string&lt;
           (symbol-name a)
           (symbol-name b)))))

(<span style="color: #00796b;">defun</span> <span style="color: #0097A7;">sb/hydra-load-theme-heads</span> (themes)
  (mapcar* (<span style="color: #00796b;">lambda</span> (a b)
             (list (char-to-string a)
                   `(sb/load-theme ',b)
                   (symbol-name b)))
           sb/hydra-selectors themes))

(<span style="color: #00796b;">bind-keys</span> (<span style="color: #689f38;">"C-c w t"</span> .
            (<span style="color: #00796b;">lambda</span> ()
              (<span style="color: #00796b;">interactive</span>)
              (call-interactively
               (eval `(<span style="color: #00796b;">defhydra</span> sb/hydra-select-themes
                        (<span style="color: #B71C1C;">:hint</span> nil <span style="color: #B71C1C;">:color</span> pink)
                        <span style="color: #689f38;">"Select Theme"</span>
                        ,@(sb/hydra-load-theme-heads
                           (sb/sort-themes
                            (custom-available-themes)))
                        (<span style="color: #689f38;">"DEL"</span> (sb/disable-all-themes))
                        (<span style="color: #689f38;">"RET"</span> nil <span style="color: #689f38;">"done"</span> <span style="color: #B71C1C;">:color</span> blue)))))))
</pre>
</div>

<p>
For what it's worth, here's my full <a href="https://github.com/stig/dot-files/blob/master/emacs.d/Themes.org">Emacs Themes Config</a> on Github.
</p>
</div>
<div id="postamble" class="status">
<p class="author">Author: <a href="/contact.html">Stig Brautaset</a></p>
<p class="licence">Licence: <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a></p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
