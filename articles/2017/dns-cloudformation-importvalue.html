<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Updating DNS with output of another CloudFormation stack</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Stig Brautaset">
<link rel="stylesheet" type="text/css" href="/css/main.css" />
<link rel="icon" type="image/png" href="/images/icon.png" />
<script type="text/javascript">
if(/superloopy.io/.test(window.location.hostname)) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-4113456-6', 'auto');
  ga('send', 'pageview');
}
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>

<div id="org-div-home-and-up">
  <a href="/"><img src="/images/logo.png" alt="Superloopy Logo"/></a>
  <nav>
    <ul>
      <li><a accesskey="H" href="/"> Home </a></li>
      <li><a accesskey="p" href="/publications.html"> Publications </a></li>
      <li><a accesskey="A" href="/about.html"> About </a></li>
      <li><a accesskey="c" href="/contact.html"> Contact </a></li>
      <li>Licence: <a accesskey="l" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a></li>
    </ul>
  </nav>
</div>
<div id="content">
<h1 class="title">Updating DNS with output of another CloudFormation stack</h1>
<div class="abstract">
<p>
I show the changes to my Sceptre config &amp; CloudFormation template
required to point DNS to my the two CloudFront distributions I've
created.
</p>

</div>
<p>
This post is part of a series where I <a href="adding-ssl.html">add SSL</a> to this blog. The <code>www</code>
template I created in two <a href="ssl-enabled-s3-redirects-with-cloudformation.html">previous</a> <a href="s3-website-with-https-using-cloudformation.html">posts</a> had two outputs defined for
the CloudFront distributions created, so that I could import these
values in my <code>dns</code> template and avoid hard-coding their domain names.
This post shows the changes required to do just that.
</p>

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#out-updates">Updated Outputs</a></li>
<li><a href="#cfg-updates">Config file update</a></li>
<li><a href="#recordset-updates">RecordSet updates</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</div>
</div>

<div id="outline-container-org695bfaa" class="outline-2">
<h2 id="out-updates"><a id="org695bfaa"></a>Updated Outputs</h2>
<div class="outline-text-2" id="text-out-updates">
<p>
Let's dive right in. According to the <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/outputs-section-structure.html">Outputs</a> documentation you need
to add the optional <code>Export</code> object to the output, giving the fully
qualified <code>Name</code> to be used for the variable. It is heavily implied that
you should try to work the <i>StackName</i> into this names somehow. That's
what we're doing on lines <a href="#coderef-exp1" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-exp1');" onmouseout="CodeHighlightOff(this, 'coderef-exp1');">9</a> and <a href="#coderef-exp2" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-exp2');" onmouseout="CodeHighlightOff(this, 'coderef-exp2');">16</a>. I've also added a new
variable, <a href="#coderef-sn" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-sn');" onmouseout="CodeHighlightOff(this, 'coderef-sn');"><code>StackName</code></a>, which I'll get back to in a moment.
</p>

<div class="org-src-container">
<pre><code class="src src-yaml"><span class="linenr"> 1: </span><span style="color: #EF6C00;">Outputs</span>:
<span class="linenr"> 2: </span>  <span style="color: #EF6C00;">RedirDomain</span>:
<span class="linenr"> 3: </span>    <span style="color: #EF6C00;">Description</span>: &gt;-
<span class="linenr"> 4: </span>      <span style="color: #689f38;">The CloudFront domain name for our Apex domain that we use to</span>
<span class="linenr"> 5: </span><span style="color: #689f38;">      redirect to our SiteDomain. We will use this to add a CNAME from</span>
<span class="linenr"> 6: </span><span style="color: #689f38;">      our DNS template.</span>
<span class="linenr"> 7: </span>    <span style="color: #EF6C00;">Value</span>: <span style="color: #0097A7;">!GetAtt</span> ApexCloudFront.DomainName
<span class="linenr"> 8: </span>    <span style="color: #EF6C00;">Export</span>:
<span id="coderef-exp1" class="coderef-off"><span class="linenr"> 9: </span>      <span style="color: #EF6C00;">Name</span>: <span style="color: #0097A7;">!Sub</span> <span style="color: #689f38;">"${AWS::StackName}-RedirDomain"</span></span>
<span class="linenr">10: </span>  <span style="color: #EF6C00;">SiteDomain</span>:
<span class="linenr">11: </span>    <span style="color: #EF6C00;">Description</span>: &gt;-
<span class="linenr">12: </span>      <span style="color: #689f38;">The CloudFront domain name for our site. We will use this to add</span>
<span class="linenr">13: </span><span style="color: #689f38;">      a CNAME from our DNS template.</span>
<span class="linenr">14: </span>    <span style="color: #EF6C00;">Value</span>: <span style="color: #0097A7;">!GetAtt</span> SiteCloudFront.DomainName
<span class="linenr">15: </span>    <span style="color: #EF6C00;">Export</span>:
<span id="coderef-exp2" class="coderef-off"><span class="linenr">16: </span>      <span style="color: #EF6C00;">Name</span>: <span style="color: #0097A7;">!Sub</span> <span style="color: #689f38;">"${AWS::StackName}-SiteDomain"</span></span>
<span class="linenr">17: </span>  <span style="color: #EF6C00;">StackName</span>:
<span class="linenr">18: </span>    <span style="color: #EF6C00;">Description</span>: &gt;-
<span class="linenr">19: </span>      <span style="color: #689f38;">The stack name to use for templates that depend on this one.</span>
<span id="coderef-sn" class="coderef-off"><span class="linenr">20: </span>    <span style="color: #EF6C00;">Value</span>: <span style="color: #0097A7;">!Ref</span> <span style="color: #689f38;">'AWS::StackName'</span></span>
</code></pre>
</div>

<p>
Now, the required changes to the DNS template from <a href="route-53-cloudformation.html#full-template">a previous post</a>. We
start by removing the <code>ApexRecords</code> and <code>WwwRecord</code>, as we'll get these
from the WWW template. We'll add a new <code>DependentStackName</code> parameter,
like so:
</p>

<div class="org-src-container">
<pre><code class="src src-yaml"><span style="color: #EF6C00;">Parameters</span>:
  [...]
  <span style="color: #EF6C00;">DependentStackName</span>:
    <span style="color: #EF6C00;">Type</span>: String
    <span style="color: #EF6C00;">Description</span>: &gt;-
      <span style="color: #689f38;">Name of stack we depend on and will grab exported values from.</span>
<span style="color: #689f38;">      Computed by Sceptre.</span>
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org7dbc495" class="outline-2">
<h2 id="cfg-updates"><a id="org7dbc495"></a>Config file update</h2>
<div class="outline-text-2" id="text-cfg-updates">
<p>
As you can infer from the comment in the previous section, <a href="https://sceptre.cloudreach.com">Sceptre</a>
provides a bit of magic to obtain the stack name from the WWW template
as an input to the DNS one. To make use of that I added the below
<code>!stack_output</code> Sceptre fragment to <code>config/superloopy/dns.yaml</code>. This
file is so short that I'm just showing it in its entirety here:
</p>

<div class="org-src-container">
<pre><code class="src src-yaml"><span style="color: #EF6C00;">template_path</span>: templates/dns.yaml
<span style="color: #EF6C00;">parameters</span>:
  <span style="color: #EF6C00;">DomainName</span>: superloopy.io
  <span style="color: #EF6C00;">DependentStackName</span>: <span style="color: #0097A7;">!stack_output</span> www::StackName
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org9161b40" class="outline-2">
<h2 id="recordset-updates"><a id="org9161b40"></a>RecordSet updates</h2>
<div class="outline-text-2" id="text-recordset-updates">
<p>
Let's start with the <code>WwwRecordSet</code> since that's the simplest change.
The only thing we <i>need</i> to change here is the <code>ResourceRecord</code> list.
Instead of <code>!Ref WwwRecord</code> we'll replace it with our imported value
from our dependent stack. (While researching how to do this I found
examples of using the <code>!Sub</code> function which resulted in a much nicer way
to produce the fqdn from the apex domain; see <a href="#coderef-name" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-name');" onmouseout="CodeHighlightOff(this, 'coderef-name');">name</a>.) The
<code>WwwRecordSet</code> now looks like this:
</p>

<div class="org-src-container">
<pre><code class="src src-yaml"><span style="color: #EF6C00;">WwwRecordSet</span>:
  <span style="color: #EF6C00;">Type</span>: <span style="color: #689f38;">'AWS::Route53::RecordSet'</span>
  <span style="color: #EF6C00;">Properties</span>:
<span id="coderef-name" class="coderef-off">    <span style="color: #EF6C00;">Name</span>: <span style="color: #0097A7;">!Sub</span> <span style="color: #689f38;">"www.${DomainName}"</span> (name)</span>
    <span style="color: #EF6C00;">HostedZoneId</span>: <span style="color: #0097A7;">!Ref</span> Zone
    <span style="color: #EF6C00;">Type</span>: CNAME
    <span style="color: #EF6C00;">TTL</span>: <span style="color: #0097A7;">!Ref</span> TTL
    <span style="color: #EF6C00;">ResourceRecords</span>:
      - <span style="color: #EF6C00;">Fn::ImportValue</span>: <span style="color: #0097A7;">!Sub</span> <span style="color: #689f38;">"${DependentStackName}-SiteDomain"</span>
</code></pre>
</div>

<p>
The <code>ApexRecordSet</code> requires a different change. You can't CNAME the
Apex domain, but AWS Route 53 supports an <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-route53-recordset.html#cfn-route53-recordset-aliastarget"><code>AliasTarget</code></a> extension that
we can use instead. This is handy since we don't want to hard-code all
of CloudFront's IP addresses like we did previously with GitHub. The
new resource is in the next snippet. Note that I found the "magic"
<code>HostedZoneId</code> on line <a href="#coderef-magic" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-magic');" onmouseout="CodeHighlightOff(this, 'coderef-magic');">10</a> in the <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-route53-aliastarget.html#cfn-route53-aliastarget-hostedzoneid">AliasTarget documentation</a><sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>.
</p>

<div class="org-src-container">
<pre><code class="src src-yaml"><span style="color: #EF6C00;">ApexRecordSet</span>:
  <span style="color: #EF6C00;">Type</span>: <span style="color: #689f38;">'AWS::Route53::RecordSet'</span>
  <span style="color: #EF6C00;">Properties</span>:
    <span style="color: #EF6C00;">Name</span>: <span style="color: #0097A7;">!Ref</span> DomainName
    <span style="color: #EF6C00;">HostedZoneId</span>: <span style="color: #0097A7;">!Ref</span> Zone
    <span style="color: #EF6C00;">Type</span>: A
    <span style="color: #EF6C00;">AliasTarget</span>:
      <span style="color: #EF6C00;">DNSName</span>:
        <span style="color: #EF6C00;">Fn::ImportValue</span>: <span style="color: #0097A7;">!Sub</span> <span style="color: #689f38;">"${DependentStackName}-RedirDomain"</span>
<span id="coderef-magic" class="coderef-off">      <span style="color: #EF6C00;">HostedZoneId</span>: Z2FDTNDATAQYW2</span>
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org802e03c" class="outline-2">
<h2 id="conclusion"><a id="org802e03c"></a>Conclusion</h2>
<div class="outline-text-2" id="text-conclusion">
<p>
This change concludes the work to add SSL to my blog. The only bit I
haven't shown is how to tell Gandi to use the name servers I've
configured on AWS Route 53 rather than the default ones, but I feel
that is outside the scope of this blog series. It's now done, however,
and if you're reading this you're getting<sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup> the full experience of my
HTTPS-enabled blog :-)
</p>
</div>
</div>
<div id="footnotes"><!--Footnotes-->
<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara">I
didn't see much reason to make it a template property as it is used
<i>everywhere</i> you create an <code>AliasTarget</code> for a CloudFront domain.</div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara"><p class="footpara">
Or, as it happens, maybe not yet. Because it turns out lots of
home routers (including my own) ignore TTLs and cache DNS servers for
a long time. So for a week or so I'll leave the generated files in
GitHub, and also post new content to the AWS S3 bucket. 
</p></div></div>

</div></div>
<div id="postamble" class="status">
<p class="date">Date: 23 July 2017</p>
<p class="author">Author: Stig Brautaset</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
