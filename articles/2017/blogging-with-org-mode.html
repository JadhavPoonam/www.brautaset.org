<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Blogging with Org mode</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Stig Brautaset">
<link rel="stylesheet" type="text/css" href="/css/main.css" />
<link rel="icon" type="image/png" href="/images/icon.png" />
<script type="text/javascript">
if(/superloopy.io/.test(window.location.hostname)) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-4113456-6', 'auto');
  ga('send', 'pageview');
}
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>

<div id="org-div-home-and-up">
  <a href="/"><img src="/images/logo.png" alt="Superloopy Logo"/></a>
  <nav>
    <ul>
      <li><a accesskey="H" href="/"> Home </a></li>
      <li><a accesskey="p" href="/publications.html"> Publications </a></li>
      <li><a accesskey="A" href="/about.html"> About </a></li>
      <li><a accesskey="c" href="/contact.html"> Contact </a></li>
      <li>Licence: <a accesskey="l" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a></li>
    </ul>
  </nav>
</div>
<div id="content">
<h1 class="title">Blogging with Org mode
<br>
<span class="subtitle">And using Emacs as a build tool</span>
</h1>
<div class="abstract">
<p>
I describe how&#x2014;and why&#x2014;I changed from blogging using Markdown &amp;
Jekyll to using Org mode.
</p>

</div>
<p>
As my love-affair with Org mode continue to deepen, blogging with
Markdown Jekyll was starting to chafe. I wanted to write my blog posts
in Org mode instead. I looked around to find a Jekyll plugin that
would allow that, campaigned to have it updated to Jekyll 3, and
opened a <a href="https://github.com/github/pages-gem/pull/335">pull request against pages-gem</a> to whitelist this plugin for
use with Github Pages. Unfortunately, this PR was given the silent
treatment and I ended up closing it: given all the attention my
one-line change was not getting, it was clear they were not keen to
merge it. Thus I decided to transform by blog into an Org mode
project, and I now use Org mode's publishing to generate the HTML
pages.
</p>

<p>
<b>Why move away from Jekyll?</b> I could have moved to just use the plugin
locally, but given I had to check in generated HTML anyway I saw few
benefits to it. I was in a bad place with Jekyll: for various boring
reasons almost every time I wanted to blog I had to install ruby &amp;
Jekyll anew&#x2014;and potentially struggle to install nokogiri <i>again</i>.
</p>

<p>
<b>What are the benefits to going full Org mode?</b> Well, the editing
experience is just so much <i>better</i>, IMO. It supports a rich &amp;
extensible set of markup that is nevertheless very easy to get right.
The table support is fantastic. Inter-linking of documents works
incredibly well, and works both in source form and exported form. The
support for editing code examples with syntax highlighting provided by
the major mode is outstanding. Org mode supports inline images <i>in the
source</i> version. Finally it's written in&#x2014;and can be customised
with&#x2014;Emacs lisp, which is much more approachable (to me) than Ruby.
</p>

<p>
In short, I'm hoping that this transformation will reduce my (mostly
artificial) barrier to blogging, aiding me to blog more often. To
<i>further</i> reduce the barrier to entry I have an Org template for blog
posts, which you can see in listing <a href="#org1348283">1</a>. Org mode will
prompt for all the <code>%^{Something</code>} entries.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>Org blog post template</label><pre class="src src-org" id="org1348283"><span style="color: #558b2f; font-size: 135%;">#+title:</span> <span style="color: #212121; font-size: 135%; font-weight: bold;">%^{Title}</span>
<span style="color: #558b2f; font-size: 135%;">#+date:</span> <span style="color: #00796b; font-size: 135%;">%&lt;%Y-%m-%d&gt;</span>
<span style="color: #4e342e; background-color: #efebe9;">#+begin_abstract</span>
%^{Abstract}
<span style="color: #4e342e; background-color: #efebe9;">#+end_abstract</span>
<span style="color: #607d8b;">#+index: %^{Concept Index Entry}</span>

%?
</pre>
</div>

<p>
I include this in my capture templates in a slightly unusual way.
Usually Org is expecting to capture into existing files, but I want a
new file created each time with a name I specify. So at capture time I
separately query for a title to use in the URL&#x2014;aka "the slug". I
cannot take this from the capture template expansion of <code>%^{Title},</code>
regretfully, because the prompts for that don't run until the file has
been created. The capture entry can be seen in listing <a href="#orgf57b0ea">2</a>,
and the function to prompt for the slug in listing <a href="#org60d35d3">3</a>.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>Blog post capture entry</label><pre class="src src-emacs-lisp" id="orgf57b0ea">(add-to-list 'org-capture-templates
             '(<span style="color: #689f38;">"b"</span> <span style="color: #689f38;">"Blog Post"</span> plain
               (file (capture-blog-post-file))
               (file <span style="color: #689f38;">"tpl-blog-post.org"</span>)))
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>Prompt for blog post file name</label><pre class="src src-emacs-lisp" id="org60d35d3">(<span style="color: #00796b;">defun</span> <span style="color: #0097A7;">capture-blog-post-file</span> ()
  (<span style="color: #00796b;">let*</span> ((title (read-string <span style="color: #689f38;">"Slug: "</span>))
         (slug (replace-regexp-in-string <span style="color: #689f38;">"[</span><span style="color: #2196f3;">^</span><span style="color: #689f38;">a-z]+"</span> <span style="color: #689f38;">"-"</span> (downcase title))))
    (expand-file-name
     (format <span style="color: #689f38;">"~/blog/articles/%s/%s.org"</span>
             (format-time-string <span style="color: #689f38;">"%Y"</span> (current-time))
             slug))))
</pre>
</div>

<p>
Finally, the code to build the blog are available in a script called
<code>build.el</code> in my blog's root. It can be run from the commandline with
Emacs in batch mode, or I could eval the configuration into my running
Emacs instance and publish individual pages while I'm working on them.
The current version of this script can be seen in listing <a href="#orge605550">4</a>.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>Script to build blog</label><pre class="src src-emacs-lisp" id="orge605550">#!/usr/bin/env emacs --script

(<span style="color: #00796b;">require</span> '<span style="color: #558b2f;">package</span>)
(package-initialize)

<span style="color: #607d8b;">;; </span><span style="color: #607d8b;">Require modes used for syntax highlighting of code examples</span>
(<span style="color: #00796b;">require</span> '<span style="color: #558b2f;">clojure-mode</span>)
(<span style="color: #00796b;">require</span> '<span style="color: #558b2f;">scala-mode</span>)
(<span style="color: #00796b;">require</span> '<span style="color: #558b2f;">cc-mode</span>)
(<span style="color: #00796b;">require</span> '<span style="color: #558b2f;">sh-script</span>)

<span style="color: #607d8b;">;; </span><span style="color: #607d8b;">Require org export</span>
(<span style="color: #00796b;">require</span> '<span style="color: #558b2f;">ox</span>)


(<span style="color: #00796b;">setq</span> project-path (file-name-directory
                    (<span style="color: #00796b;">or</span> (buffer-file-name)
                        load-file-name))

      <span style="color: #607d8b;">;; </span><span style="color: #607d8b;">Avoid foo~ backup files everywhere</span>
      backup-directory-alist `((<span style="color: #689f38;">"."</span> . ,(concat user-emacs-directory <span style="color: #689f38;">"backups"</span>)))

      <span style="color: #607d8b;">;; </span><span style="color: #607d8b;">For now deploy side-by-side, since I cannot figure out how to</span>
      <span style="color: #607d8b;">;; </span><span style="color: #607d8b;">simulate a Jekyll site so it will deploy from _site :-(</span>
      publish-path project-path <span style="color: #607d8b;">;; </span><span style="color: #607d8b;">(concat project-path "_site/")</span>

      org-html-doctype <span style="color: #689f38;">"html5"</span>

      org-html-home/up-format <span style="color: #689f38;">"</span>
<span style="color: #689f38;">&lt;div id=\"org-div-home-and-up\"&gt;</span>
<span style="color: #689f38;">  &lt;img src=\"/images/logo.png\" alt=\"Superloopy Logo\"/&gt;</span>
<span style="color: #689f38;">  &lt;nav&gt;</span>
<span style="color: #689f38;">    &lt;ul&gt;</span>
<span style="color: #689f38;">      &lt;!-- &lt;li&gt;&lt;a accesskey=\"h\" href=\"%s\"&gt; Up &lt;/a&gt;&lt;/li&gt;\n --&gt;</span>
<span style="color: #689f38;">      &lt;li&gt;&lt;a accesskey=\"H\" href=\"%s\"&gt; Home &lt;/a&gt;&lt;/li&gt;</span>
<span style="color: #689f38;">      &lt;li&gt;&lt;a accesskey=\"a\" href=\"/articles\"&gt; Articles &lt;/a&gt;&lt;/li&gt;</span>
<span style="color: #689f38;">      &lt;li&gt;&lt;a accesskey=\"p\" href=\"/publications.html\"&gt; Publications &lt;/a&gt;&lt;/li&gt;</span>
<span style="color: #689f38;">      &lt;li&gt;&lt;a accesskey=\"A\" href=\"/about.html\"&gt; About &lt;/a&gt;&lt;/li&gt;</span>
<span style="color: #689f38;">    &lt;/ul&gt;</span>
<span style="color: #689f38;">  &lt;/nav&gt;</span>
<span style="color: #689f38;">&lt;/div&gt;</span>
<span style="color: #689f38;">"</span>

      org-html-head (concat <span style="color: #689f38;">"&lt;link rel=\"stylesheet\" type=\"text/css\" href=\"/css/main.css\" /&gt;\n"</span>
                            <span style="color: #689f38;">"&lt;link rel=\"icon\" type=\"image/png\" href=\"/images/icon.png\" /&gt;"</span>)

      org-html-scripts (concat org-html-scripts
                               <span style="color: #689f38;">"</span>
<span style="color: #689f38;">&lt;script type=\"text/javascript\"&gt;</span>
<span style="color: #689f38;">if(/superloopy</span><span style="color: #B71C1C; font-weight: bold;">\</span><span style="color: #689f38;">.io/.test(window.location.hostname)) {</span>
<span style="color: #689f38;">  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){</span>
<span style="color: #689f38;">  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),</span>
<span style="color: #689f38;">  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)</span>
<span style="color: #689f38;">  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');</span>
<span style="color: #689f38;">  ga('create', 'UA-4113456-6', 'auto');</span>
<span style="color: #689f38;">  ga('send', 'pageview');</span>
<span style="color: #689f38;">}</span>
<span style="color: #689f38;">&lt;/script&gt;"</span>)

      org-html-link-home <span style="color: #689f38;">"/"</span>
      org-html-link-up <span style="color: #689f38;">"/"</span>

      org-export-with-toc nil
      org-export-with-author t
      org-export-with-email nil
      org-export-with-creator nil
      org-export-with-section-numbers nil

      org-html-preamble nil
      org-html-postamble 'auto

      org-publish-project-alist
      `((<span style="color: #689f38;">"static"</span>
         <span style="color: #B71C1C;">:base-directory</span> ,project-path
         <span style="color: #B71C1C;">:base-extension</span> <span style="color: #689f38;">"css</span><span style="color: #FFA000;">\\</span><span style="color: #4527A0;">|</span><span style="color: #689f38;">png</span><span style="color: #FFA000;">\\</span><span style="color: #4527A0;">|</span><span style="color: #689f38;">jpg</span><span style="color: #FFA000;">\\</span><span style="color: #4527A0;">|</span><span style="color: #689f38;">pdf"</span>
         <span style="color: #B71C1C;">:exclude</span> <span style="color: #689f38;">"_site"</span>
         <span style="color: #B71C1C;">:publishing-directory</span> ,publish-path
         <span style="color: #B71C1C;">:publishing-function</span> org-publish-attachment
         <span style="color: #B71C1C;">:recursive</span> t)

        (<span style="color: #689f38;">"home"</span>
         <span style="color: #B71C1C;">:base-directory</span> ,project-path
         <span style="color: #B71C1C;">:publishing-directory</span> ,publish-path
         <span style="color: #B71C1C;">:publishing-function</span> org-html-publish-to-html)

        (<span style="color: #689f38;">"articles"</span>
         <span style="color: #B71C1C;">:base-directory</span> ,(concat project-path <span style="color: #689f38;">"articles"</span>)
         <span style="color: #B71C1C;">:makeindex</span> t
         <span style="color: #B71C1C;">:publishing-directory</span> ,(concat publish-path <span style="color: #689f38;">"articles"</span>)
         <span style="color: #B71C1C;">:publishing-function</span> org-html-publish-to-html
         <span style="color: #B71C1C;">:recursive</span> t)))

(org-publish-all)
</pre>
</div>

<p>
Some of my recent posts had been written in Org mode already, but had
been exported to HTML for publication as per <a href="../2016/how-i-blog-this-week.html">my previous post on
blogging</a>. Those were easy to convert, and required only minor edits.
Once it was clear that the concept would work, I wrote a script that
did a decent first pass of transforming the existing articles from
Markdown to Org using <a href="http://pandoc.org">Pandoc</a>, and then fixed the remaining doodaahs
manually. You can see my hacky conversion script in listing
<a href="#orge9719dc">5</a>.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>Rough conversion from Jekyll-style Markdown-with-YAML-frontmatter to Org</label><pre class="src src-fish" id="orge9719dc"><span style="color: #00796b;">function</span> <span style="color: #0097A7;">md2org</span> <span style="color: #2196f3;">--description</span> <span style="color: #689f38;">'Convert .md blog post to Org'</span>
        <span style="color: #00796b;">for</span> <span style="color: #B71C1C;">file</span> in <span style="color: #689f38;">$</span><span style="color: #EF6C00;">argv</span>
                <span style="color: #00796b;">set</span> <span style="color: #EF6C00;">year</span> (<span style="color: #B71C1C;">echo</span> <span style="color: #689f38;">$</span><span style="color: #EF6C00;">file</span> <span style="color: #2196f3;">|</span> <span style="color: #B71C1C;">cut</span> -d- -f1)
                <span style="color: #00796b;">set</span> <span style="color: #EF6C00;">date</span> (<span style="color: #B71C1C;">echo</span> <span style="color: #689f38;">$</span><span style="color: #EF6C00;">file</span> <span style="color: #2196f3;">|</span> <span style="color: #B71C1C;">cut</span> -d- -f1-3)
                <span style="color: #00796b;">set</span> <span style="color: #EF6C00;">slug</span> (<span style="color: #B71C1C;">echo</span> <span style="color: #689f38;">$</span><span style="color: #EF6C00;">file</span> <span style="color: #2196f3;">|</span> <span style="color: #B71C1C;">cut</span> -d- -f4- <span style="color: #2196f3;">|</span> <span style="color: #B71C1C;">cut</span> -d. -f1)

                <span style="color: #B71C1C;">mkdir</span> -p ~/blog/articles/$year
                <span style="color: #00796b;">set</span> <span style="color: #EF6C00;">f</span> ~/blog/articles/$year/$slug.org

                <span style="color: #B71C1C;">echo</span> <span style="color: #689f38;">"#+"</span>(grep -m <span style="color: #558b2f;">1</span> <span style="color: #689f38;">'^title:'</span> <span style="color: #689f38;">$</span><span style="color: #EF6C00;">file</span>) &gt; <span style="color: #689f38;">$</span><span style="color: #EF6C00;">f</span>
                <span style="color: #B71C1C;">echo</span> <span style="color: #689f38;">"#+date: $date"</span><span style="color: #2196f3;"> &gt;&gt;</span> <span style="color: #689f38;">$</span><span style="color: #EF6C00;">f</span>

                <span style="color: #00796b;">if</span> <span style="color: #00796b;">set</span> <span style="color: #EF6C00;">abstract</span> (<span style="color: #B71C1C;">grep</span> -m <span style="color: #558b2f;">1</span> <span style="color: #689f38;">'^abstract:'</span> <span style="color: #689f38;">$</span><span style="color: #EF6C00;">file</span>)
                        <span style="color: #00796b;">set</span> <span style="color: #EF6C00;">abstract</span> (<span style="color: #B71C1C;">echo</span> <span style="color: #689f38;">$</span><span style="color: #EF6C00;">abstract</span> <span style="color: #2196f3;">|</span> <span style="color: #B71C1C;">sed</span> <span style="color: #689f38;">'s/abstract: //'</span>)
                        <span style="color: #B71C1C;">echo</span> <span style="color: #689f38;">"#+begin_abstract"</span><span style="color: #2196f3;"> &gt;&gt;</span> <span style="color: #689f38;">$</span><span style="color: #EF6C00;">f</span>
                        <span style="color: #B71C1C;">echo</span> <span style="color: #689f38;">$</span><span style="color: #EF6C00;">abstract</span><span style="color: #2196f3;"> &gt;&gt;</span> <span style="color: #689f38;">$</span><span style="color: #EF6C00;">f</span>
                        <span style="color: #B71C1C;">echo</span> <span style="color: #689f38;">"#+end_abstract"</span><span style="color: #2196f3;"> &gt;&gt;</span> <span style="color: #689f38;">$</span><span style="color: #EF6C00;">f</span>
                <span style="color: #00796b;">end</span>

                <span style="color: #00796b;">if</span> <span style="color: #00796b;">set</span> <span style="color: #EF6C00;">tags</span> (<span style="color: #B71C1C;">grep</span> -m <span style="color: #558b2f;">1</span> <span style="color: #689f38;">'^tags:'</span> <span style="color: #689f38;">$</span><span style="color: #EF6C00;">file</span>)
                        <span style="color: #00796b;">set</span> <span style="color: #EF6C00;">tags</span> (<span style="color: #B71C1C;">sed</span> <span style="color: #689f38;">'s/tags: //'</span> <span style="color: #2196f3;">|</span> <span style="color: #B71C1C;">tr</span> -d <span style="color: #689f38;">'[,]'</span>)
                        <span style="color: #00796b;">for</span> <span style="color: #B71C1C;">tag</span> in <span style="color: #689f38;">$</span><span style="color: #EF6C00;">tags</span>
                                <span style="color: #B71C1C;">echo</span> <span style="color: #689f38;">"#+index: $tag"</span><span style="color: #2196f3;"> &gt;&gt;</span> <span style="color: #689f38;">$</span><span style="color: #EF6C00;">f</span>
                        <span style="color: #00796b;">end</span>
                <span style="color: #00796b;">end</span>

                <span style="color: #B71C1C;">echo</span><span style="color: #2196f3;"> &gt;&gt;</span> <span style="color: #689f38;">$</span><span style="color: #EF6C00;">f</span>

                <span style="color: #B71C1C;">sed</span> <span style="color: #689f38;">'/^---$/,/^---$/d'</span> <span style="color: #689f38;">$</span><span style="color: #EF6C00;">file</span> <span style="color: #2196f3;">\</span>
                <span style="color: #2196f3;">|</span> pandoc --no-highlight <span style="color: #2196f3;">\</span>
                <span style="color: #B71C1C;">-f</span> markdown+backtick_code_blocks+fenced_code_attributes <span style="color: #2196f3;">\</span>
                <span style="color: #B71C1C;">-t</span> org <span style="color: #2196f3;">\</span>
<span style="color: #2196f3;">                &gt;&gt;</span> <span style="color: #689f38;">$</span><span style="color: #EF6C00;">f</span>

                <span style="color: #B71C1C;">echo</span> <span style="color: #689f38;">$</span><span style="color: #EF6C00;">year</span> -- <span style="color: #689f38;">$</span><span style="color: #EF6C00;">date</span> -- <span style="color: #689f38;">$</span><span style="color: #EF6C00;">slug</span>
        <span style="color: #00796b;">end</span>
<span style="color: #00796b;">end</span>
</pre>
</div>

<p>
<b>Preview.</b> One of the nice things Jekyll provided was a web server, so
you could preview things in a browser properly. In this new solution
I've been using Python's <code>SimpleHTTPServer</code> instead. I cd into the blog
directory in a Terminal window and issue the following command, which
serves files from the current directory as a web site.
</p>

<div class="org-src-container">
<pre class="src src-sh">python -m SimpleHTTPServer
</pre>
</div>

<p>
<b>What is missing?</b> Obviously things are not perfect. If they were, there
would be no reason to continue this blog! Here are two specific gripes I
haven't managed to solve yet:
</p>

<ul class="org-ul">
<li>Auto-generated list of latest posts. Org publishing supports an
index, which I'm using, and a sitemap&#x2013;but the latter is dog slow
and inflexible, resulting in poor quality output. All my attempts at
getting a proper reverse chronological order of posts have failed.
There is no way to order the <i>folders</i>, so sometimes the years don't
come in the right order. I don't add posts that often, so I've
decided to live with this for now.</li>

<li>I am still checking in generated HTML pages. I would rather avoid
this. Potentially I could fix this by hosting in S3 instead. That
way I could probably enable HTTPS too, since AWS ACM gives you free
certs.</li>
</ul>
</div>
<div id="postamble" class="status">
<p class="date">Date:  3 June 2017</p>
<p class="author">Author: Stig Brautaset</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
