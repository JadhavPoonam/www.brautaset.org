<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2017-06-03 Sat 08:27 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Spray Example</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Stig Brautaset">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="/css/main.css" />
<link rel="icon" type="image/png" href="/images/icon.png" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/javascript">
if(/superloopy.io/.test(window.location.hostname)) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-4113456-6', 'auto');
  ga('send', 'pageview');
}
</script>
</head>
<body>

<div id="org-div-home-and-up">
  <img src="/images/logo.png" alt="Superloopy Logo"/>
  <nav>
    <ul>
      <!-- <li><a accesskey="h" href="/"> Up </a></li>
 -->
      <li><a accesskey="H" href="/"> Home </a></li>
      <li><a accesskey="a" href="/articles"> Articles </a></li>
      <li><a accesskey="p" href="/publications.html"> Publications </a></li>
      <li><a accesskey="A" href="/about.html"> About </a></li>
    </ul>
  </nav>
</div>
<div id="content">
<h1 class="title">Spray Example</h1>
<p>
I love using <a href="http://spray.io">Spray</a> and its routing DSL for REST APIs but I've found a
lot of the examples are just showing off its syntax. I've been missing
examples of how you can use it to wire together a real application.
Therefore I put together an <a href="https://github.com/stig/spray-example/">example</a> that goes a bit beyond the routing
syntax to document my current understanding of best practices in that
regard.
</p>

<p>
The main goal of this example is to show how to wire together a REST API
using Spray Routing (v1.2) that uses a model-actor from the spray
routing layer. It also shows off a few things I consider good practice:
</p>

<ul class="org-ul">
<li>Custom <code>Cache-Control</code> header generation. Achieve optimal caching by
tailoring a resource's <code>max-age</code> to avoid over- or under-caching
individual resources.</li>

<li>Separate on-the-wire protocol. I've see codebases where the domain
objects contain more annotations than code&#x2014;often for both JSON and
ORM mappings. I think this is bad practice and prefer to use
different classes.</li>

<li>The <a href="http://spray.io/documentation/1.2.0/spray-routing/future-%20directives/onSuccess/">onSuccess</a> directive, which allows us to improve on my <a href="file:///Users/stig/blog/articles/2013/spray-routing-error-handling.html">previous</a>
post on handling expected errors (e.g. 404) in the spray routing
DSL.</li>
</ul>

<p>
Let's start with the <a href="https://github.com/stig/spray-example/blob/master/src/main/scala/example/ModelActor.scala">ModelActor</a>. It is really just a toy, because the
purpose of this example is to show how you plug an actor-based model
into spray routing. There's just one thing I want to point out: the
<a href="https://github.com/stig/spray-example/blob/master/src/main/scala/example/Model.scala">Model</a> has a method <code>get(id: Int): Option[Item]</code>, but it is considered
bad practice to send <code>Some[Item]</code> and <code>None</code> messages between actors.
Actors have much more freedom when it comes to the types of messages
it responds with so we transform the response from the model into <code>Item</code>
or <code>ItemNotFound</code> as appropriate.
</p>

<p>
Next let's look at the <a href="https://github.com/stig/spray-example/blob/master/src/main/scala/example/Service.scala">Service</a>. For clarity the following examples
focus on a single point each, but the example project puts it all
together. First, let's look at the <code>onSuccess</code> directive that lets us
handle two different success cases (or one success and one expected
error, depending on how you look at it) in stride:
</p>

<div class="org-src-container">
<pre class="src src-scala">onSuccess(model ? id) {
    <span style="font-weight: bold;">case</span> <span style="font-weight: bold; font-style: italic;">item</span><span style="font-weight: bold;">:</span> <span style="font-weight: bold; text-decoration: underline;">Item</span> <span style="font-weight: bold;">=&gt;</span> complete(<span style="font-weight: bold; text-decoration: underline;">OK</span>, item)
    <span style="font-weight: bold;">case</span> <span style="font-weight: bold; text-decoration: underline;">ItemNotFound</span> <span style="font-weight: bold;">=&gt;</span> complete(<span style="font-weight: bold; text-decoration: underline;">NotFound</span>)
}
</pre>
</div>

<p>
How do we get the <code>model</code> into the route, while still keeping things
easy to test? My preference is to make the route definition a <code>def</code>
rather than a <code>val</code> and pass in the model actor from a very thin
ServiceActor. This allows us to inject a test actor very simply and thus
create routing tests very naturally.
</p>

<p>
As mentioned I like to use a separate on-the-wire protocol&#x2014;in other
words: separate DTO classes from the model classes. The counter-argument
I've usually heard is that it's "unecessary" work; but if you're dealing
with immutable objects you're probably just copying the pointers to the
members, so you're not copying that much data around. On the other hand
it becomes a lot simpler to avoid accidental leakage of your model
fields if you never pass the model objects across the wire in the first
place.
</p>

<p>
You might wonder why I send model objects to the service layer at all:
the reason has to do with caching. Items change state and availability
depending on stock level, going from <code>InStock</code> to <code>LowStock</code> to
<code>SoldOut</code>. We want to strike a balance between caching everything too
long, or everything too short. To do that we use an item's stock level
to decide how long to cache for. (To avoid leaking exact stock levels
via the Cache-Control header's max-age we use a formula to obfuscate the
levels a bit.) Note that for a list we must pick the <i>minimum stock
level in the list</i> to use for the cache decider.
</p>

<p>
I think this gives a clean separation between the model / controller
layer and the service layer. The model layer doesn't need to know that
it is being exposed by a REST API at all.
</p>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2014-02-16</p>
<p class="author">Author: Stig Brautaset</p>
<p class="date">Created: 2017-06-03 Sat 08:27</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
