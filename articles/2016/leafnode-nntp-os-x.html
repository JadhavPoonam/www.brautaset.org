<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Setting up Leafnode on OS X</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Stig Brautaset">
<link rel="stylesheet" type="text/css" href="/css/main.css" />
<link rel="icon" type="image/png" href="/images/icon.png" />
<script type="text/javascript">
if(/superloopy.io/.test(window.location.hostname)) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-4113456-6', 'auto');
  ga('send', 'pageview');
}
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>

<div id="org-div-home-and-up">
  <a href="/"><img src="/images/logo.png" alt="Superloopy Logo"/></a>
  <nav>
    <ul>
      <li><a accesskey="H" href="/"> Home </a></li>
      <li><a accesskey="p" href="/publications.html"> Publications </a></li>
      <li><a accesskey="A" href="/about.html"> About </a></li>
      <li><a accesskey="c" href="/contact.html"> Contact </a></li>
      <li>Licence: <a accesskey="l" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a></li>
    </ul>
  </nav>
</div>
<div id="content">
<h1 class="title">Setting up Leafnode on OS X</h1>
<div class="abstract">
<p>
I set up the Leafnode NNTP server on OS X, for use with Emacs and the
Gnus newsreader.
</p>

</div>

<p>
<b>Note: Although this works, I don't actually use Leafnode any more. I
now use the <a href="https://www.gnu.org/software/emacs/manual/html_node/gnus/Agent-Basics.html">Gnus Agent</a> instead.</b>
</p>

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org4956094">Introduction</a></li>
<li><a href="#installation">Installation</a></li>
<li><a href="#configuration">Configuration</a></li>
<li><a href="#a-note-on-users">A note on users</a></li>
<li><a href="#scheduling">Scheduling</a>
<ul>
<li><a href="#fetchnews">Fetchnews</a></li>
<li><a href="#leafnode">Leafnode</a></li>
<li><a href="#texpire">Texpire</a></li>
<li><a href="#start-the-services">Start the services</a></li>
</ul>
</li>
<li><a href="#closing-notes">Closing notes</a></li>
</ul>
</div>
</div>
<div id="list-of-listings">
<h2>List of Listings</h2>
<div id="text-list-of-listings">
<ul>
<li><a href="#org0dba234"><span class="listing-number">Listing 1:</span> Example <code>/usr/local/etc/leafnode/config</code></a></li>
<li><a href="#orgfd02336"><span class="listing-number">Listing 2:</span> <code>org.brautaset.fetchnews.plist</code></a></li>
<li><a href="#org1e1c2b6"><span class="listing-number">Listing 3:</span> <code>org.brautaset.leafnode.plist</code></a></li>
<li><a href="#org1dc50e7"><span class="listing-number">Listing 4:</span> <code>org.brautaset.texpire.plist</code></a></li>
<li><a href="#org97e8165"><span class="listing-number">Listing 5:</span> Starting the services with the <code>launchctl</code> command</a></li>
</ul>
</div>
</div>

<div id="outline-container-org4956094" class="outline-2">
<h2 id="org4956094">Introduction</h2>
<div class="outline-text-2" id="text-org4956094">
<p>
I read email and news with Gnus. I often use a laptop, and often in
places I don't have internet access. Gnus doesn't like not being able to
connect to the nntp server when it starts, so as a work-around I run the
<a href="http://leafnode.sourceforge.net">Leafnode</a> NNTP server locally. As a
nice side effect, Gnus starts a lot faster.
</p>

<p>
I use <a href="http://orgmode.org">Orgmode</a> and have a <a href="https://github.com/stig/dot-files/blob/master/Leafnode.org">Leafnode.org</a> that all the configuration is
generated from. If you use Emacs, and Orgmode, you probably want to
just look at that directly. If you use some other NNTP client you
might want to read this post instead. No Emacs required :-)
</p>
</div>
</div>

<div id="outline-container-org2e1d10f" class="outline-2">
<h2 id="installation"><a id="org2e1d10f"></a>Installation</h2>
<div class="outline-text-2" id="text-installation">
<p>
First we have to install Leafnode. This is dirt simple with
<a href="http://brew.sh">homebrew</a>:
</p>

<div class="org-src-container">
<pre class="src src-sh">brew install leafnode
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd44b343" class="outline-2">
<h2 id="configuration"><a id="orgd44b343"></a>Configuration</h2>
<div class="outline-text-2" id="text-configuration">
<p>
Configuring Leafnode is also quite simple really. The action all takes
place in the <code>/usr/local/etc/leafnode/config</code> file. You have to create
this file, but there's very few required settings and there's a
well-commented example at <code>/usr/local/etc/leafnode/config.example</code> that
we can use as a reference. I'll omit comments from my example, which
you can view in listing <a href="#org0dba234">1</a>. (You obviously have to change
<code>hostname</code> to suit you.)
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>Example <code>/usr/local/etc/leafnode/config</code></label><pre class="src src-conf" id="org0dba234"><span style="color: #EF6C00;">expire</span> = 20
<span style="color: #EF6C00;">server</span> = news.gmane.org
<span style="color: #EF6C00;">initialfetch</span> = 100
<span style="color: #EF6C00;">hostname</span> = yourhost.yourdomain.com
</pre>
</div>
</div>
</div>

<div id="outline-container-org21896f2" class="outline-2">
<h2 id="a-note-on-users"><a id="org21896f2"></a>A note on users</h2>
<div class="outline-text-2" id="text-a-note-on-users">
<p>
Leafnode keeps going on about having to create a separate user to run
Leafnode. This might make sense in a multi-user setup, but for a
single-user case on my laptop it's overkill&#x2014;so I don't bother.
</p>
</div>
</div>

<div id="outline-container-org4fcd2c4" class="outline-2">
<h2 id="scheduling"><a id="org4fcd2c4"></a>Scheduling</h2>
<div class="outline-text-2" id="text-scheduling">
<p>
Leafnode is not just one program, but a collection of programs. The
three important daemons (programs) are:
</p>

<ul class="org-ul">
<li><b>fetchnews:</b> posts to and fetches articles from upstream.</li>
<li><b>leafnode:</b> the nntp server that Gnus interacts with.</li>
<li><b>texpire:</b> a periodic job that cleans up old / obsolete news.</li>
</ul>

<p>
We need to configure these to run periodically. Since we're on OS X
we'll use launchd. I've cribbed heavily from <a href="https://trac.macports.org/browser/trunk/dports/news/leafnode/files">the Leafnode macports
package</a> for these config files.
</p>

<p>
The files below all go in the <code>~/Library/LaunchAgents</code> directory.
</p>
</div>

<div id="outline-container-org408bd7e" class="outline-3">
<h3 id="fetchnews"><a id="org408bd7e"></a>Fetchnews</h3>
<div class="outline-text-3" id="text-fetchnews">
<p>
Let's run this every 30 minutes to push outgoing posts to and fetch new
articles from upstream. This is in listing <a href="#orgfd02336">2</a>.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span><code>org.brautaset.fetchnews.plist</code></label><pre class="src src-xml" id="orgfd02336"><span style="color: #689f38;">&lt;?</span><span style="color: #00796b;">xml</span><span style="color: #689f38;"> </span><span style="color: #673ab7;">version="1.0" encoding="UTF-8"</span><span style="color: #689f38;">?&gt;</span>
<span style="color: #689f38;">&lt;!</span><span style="color: #689f38;">DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span>
&lt;<span style="color: #0097A7;">plist</span> <span style="color: #EF6C00;">version</span>=<span style="color: #689f38;">"1.0"</span>&gt;
  &lt;<span style="color: #0097A7;">dict</span>&gt;
    &lt;<span style="color: #0097A7;">key</span>&gt;KeepAlive&lt;/<span style="color: #0097A7;">key</span>&gt;
    &lt;<span style="color: #0097A7;">false</span>/&gt;
    &lt;<span style="color: #0097A7;">key</span>&gt;Label&lt;/<span style="color: #0097A7;">key</span>&gt;
    &lt;<span style="color: #0097A7;">string</span>&gt;org.brautaset.fetchnews&lt;/<span style="color: #0097A7;">string</span>&gt;
    &lt;<span style="color: #0097A7;">key</span>&gt;Program&lt;/<span style="color: #0097A7;">key</span>&gt;
    &lt;<span style="color: #0097A7;">string</span>&gt;/usr/local/sbin/fetchnews&lt;/<span style="color: #0097A7;">string</span>&gt;
    &lt;<span style="color: #0097A7;">key</span>&gt;StartInterval&lt;/<span style="color: #0097A7;">key</span>&gt;
    &lt;<span style="color: #0097A7;">integer</span>&gt;1800&lt;/<span style="color: #0097A7;">integer</span>&gt;
    &lt;<span style="color: #0097A7;">key</span>&gt;WorkingDirectory&lt;/<span style="color: #0097A7;">key</span>&gt;
    &lt;<span style="color: #0097A7;">string</span>&gt;/usr/local/var/spool/news&lt;/<span style="color: #0097A7;">string</span>&gt;
  &lt;/<span style="color: #0097A7;">dict</span>&gt;
&lt;/<span style="color: #0097A7;">plist</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org931cf84" class="outline-3">
<h3 id="leafnode"><a id="org931cf84"></a>Leafnode</h3>
<div class="outline-text-3" id="text-leafnode">
<p>
Next we need to make sure that Leafnode runs when anyone (Gnus)
attempts to connect to the news server. It is best to launch it on
demand, so it does not require resources when we are not reading news.
Find it in listing <a href="#org1e1c2b6">3</a>.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span><code>org.brautaset.leafnode.plist</code></label><pre class="src src-xml" id="org1e1c2b6"><span style="color: #689f38;">&lt;?</span><span style="color: #00796b;">xml</span><span style="color: #689f38;"> </span><span style="color: #673ab7;">version="1.0" encoding="UTF-8"</span><span style="color: #689f38;">?&gt;</span>
<span style="color: #689f38;">&lt;!</span><span style="color: #689f38;">DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span>
&lt;<span style="color: #0097A7;">plist</span> <span style="color: #EF6C00;">version</span>=<span style="color: #689f38;">"1.0"</span>&gt;
  &lt;<span style="color: #0097A7;">dict</span>&gt;
    &lt;<span style="color: #0097A7;">key</span>&gt;OnDemand&lt;/<span style="color: #0097A7;">key</span>&gt;
    &lt;<span style="color: #0097A7;">true</span>/&gt;
    &lt;<span style="color: #0097A7;">key</span>&gt;Label&lt;/<span style="color: #0097A7;">key</span>&gt;
    &lt;<span style="color: #0097A7;">string</span>&gt;org.brautaset.leafnode&lt;/<span style="color: #0097A7;">string</span>&gt;
    &lt;<span style="color: #0097A7;">key</span>&gt;WorkingDirectory&lt;/<span style="color: #0097A7;">key</span>&gt;
    &lt;<span style="color: #0097A7;">string</span>&gt;/usr/local/var/spool/news&lt;/<span style="color: #0097A7;">string</span>&gt;
    &lt;<span style="color: #0097A7;">key</span>&gt;Program&lt;/<span style="color: #0097A7;">key</span>&gt;
    &lt;<span style="color: #0097A7;">string</span>&gt;/usr/local/sbin/leafnode&lt;/<span style="color: #0097A7;">string</span>&gt;
    &lt;<span style="color: #0097A7;">key</span>&gt;Sockets&lt;/<span style="color: #0097A7;">key</span>&gt;
    &lt;<span style="color: #0097A7;">dict</span>&gt;
      &lt;<span style="color: #0097A7;">key</span>&gt;Listeners&lt;/<span style="color: #0097A7;">key</span>&gt;
      &lt;<span style="color: #0097A7;">dict</span>&gt;
        &lt;<span style="color: #0097A7;">key</span>&gt;SockServiceName&lt;/<span style="color: #0097A7;">key</span>&gt;
        &lt;<span style="color: #0097A7;">string</span>&gt;nntp&lt;/<span style="color: #0097A7;">string</span>&gt;
      &lt;/<span style="color: #0097A7;">dict</span>&gt;
    &lt;/<span style="color: #0097A7;">dict</span>&gt;
    &lt;<span style="color: #0097A7;">key</span>&gt;inetdCompatibility&lt;/<span style="color: #0097A7;">key</span>&gt;
    &lt;<span style="color: #0097A7;">dict</span>&gt;
      &lt;<span style="color: #0097A7;">key</span>&gt;Wait&lt;/<span style="color: #0097A7;">key</span>&gt;
      &lt;<span style="color: #0097A7;">false</span>/&gt;
    &lt;/<span style="color: #0097A7;">dict</span>&gt;
  &lt;/<span style="color: #0097A7;">dict</span>&gt;
&lt;/<span style="color: #0097A7;">plist</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org9c43de0" class="outline-3">
<h3 id="texpire"><a id="org9c43de0"></a>Texpire</h3>
<div class="outline-text-3" id="text-texpire">
<p>
We'll run it about every 7 hours, which means that on successive days it
should run at different times of day. I do this so that there's a bigger
chance it <i>eventually</i> will run at a time the computer is on. The file
is in listing <a href="#org1dc50e7">4</a>.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span><code>org.brautaset.texpire.plist</code></label><pre class="src src-xml" id="org1dc50e7"><span style="color: #689f38;">&lt;?</span><span style="color: #00796b;">xml</span><span style="color: #689f38;"> </span><span style="color: #673ab7;">version="1.0" encoding="UTF-8"</span><span style="color: #689f38;">?&gt;</span>
<span style="color: #689f38;">&lt;!</span><span style="color: #689f38;">DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span>
&lt;<span style="color: #0097A7;">plist</span> <span style="color: #EF6C00;">version</span>=<span style="color: #689f38;">"1.0"</span>&gt;
  &lt;<span style="color: #0097A7;">dict</span>&gt;
    &lt;<span style="color: #0097A7;">key</span>&gt;KeepAlive&lt;/<span style="color: #0097A7;">key</span>&gt;
    &lt;<span style="color: #0097A7;">false</span>/&gt;
    &lt;<span style="color: #0097A7;">key</span>&gt;Label&lt;/<span style="color: #0097A7;">key</span>&gt;
    &lt;<span style="color: #0097A7;">string</span>&gt;org.brautaset.texpire&lt;/<span style="color: #0097A7;">string</span>&gt;
    &lt;<span style="color: #0097A7;">key</span>&gt;Program&lt;/<span style="color: #0097A7;">key</span>&gt;
    &lt;<span style="color: #0097A7;">string</span>&gt;/usr/local/sbin/texpire&lt;/<span style="color: #0097A7;">string</span>&gt;
    &lt;<span style="color: #0097A7;">key</span>&gt;StartInterval&lt;/<span style="color: #0097A7;">key</span>&gt;
    &lt;<span style="color: #0097A7;">integer</span>&gt;25000&lt;/<span style="color: #0097A7;">integer</span>&gt;
    &lt;<span style="color: #0097A7;">key</span>&gt;WorkingDirectory&lt;/<span style="color: #0097A7;">key</span>&gt;
    &lt;<span style="color: #0097A7;">string</span>&gt;/usr/local/var/spool/news&lt;/<span style="color: #0097A7;">string</span>&gt;
  &lt;/<span style="color: #0097A7;">dict</span>&gt;
&lt;/<span style="color: #0097A7;">plist</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc5a3af0" class="outline-3">
<h3 id="start-the-services"><a id="orgc5a3af0"></a>Start the services</h3>
<div class="outline-text-3" id="text-start-the-services">
<p>
Because we put the launchd config files in <code>~/Library/LaunchAgents</code> they
should be automatically loaded at login, so you shouldn't have to think
about it. However, you probably don't want to logout and back in again
just to load them. Luckily you can run this command to load them
manually now using the command in listing <a href="#org97e8165">5</a>.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>Starting the services with the <code>launchctl</code> command</label><pre class="src src-sh" id="org97e8165">launchctl load ~/Library/LaunchAgents/org.brautaset.{fetchnews,texpire,leafnode}.plist
</pre>
</div>

<p>
If you used your own domain name in the name of the files you obviously
also have to change the above command.
</p>
</div>
</div>
</div>

<div id="outline-container-org790fc31" class="outline-2">
<h2 id="closing-notes"><a id="org790fc31"></a>Closing notes</h2>
<div class="outline-text-2" id="text-closing-notes">
<p>
I hope you found this useful. I know I would have when I was trying to
set this up a few weeks ago!
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 12 May 2016</p>
<p class="author">Author: Stig Brautaset</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
