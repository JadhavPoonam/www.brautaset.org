<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2017-06-07 Wed 16:22 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ModSecurity and Puppet Spelunking</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Stig Brautaset">
<link rel="stylesheet" type="text/css" href="/css/main.css" />
      <link rel="icon" type="image/png" href="/images/icon.png" />
<script type="text/javascript">
if(/superloopy.io/.test(window.location.hostname)) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-4113456-6', 'auto');
  ga('send', 'pageview');
}
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>

<div id="org-div-home-and-up">
  <img src="/images/logo.png" alt="Superloopy Logo"/>
  <nav>
    <ul>
      <!-- <li><a accesskey="h" href="/"> Up </a></li>
 -->
      <li><a accesskey="H" href="/"> Home </a></li>
      <li><a accesskey="a" href="/articles"> Articles </a></li>
      <li><a accesskey="p" href="/publications.html"> Publications </a></li>
      <li><a accesskey="A" href="/about.html"> About </a></li>
    </ul>
  </nav>
</div>
<div id="content">
<h1 class="title">ModSecurity and Puppet Spelunking</h1>
<div class="abstract">
<p>
In which I investigate how to configure SecAuditLogParts for
ModSecurity with Puppet, and find I have to contribute a patch to make
it possible.
</p>

</div>
<p>
This week I have made my first (non-README) contribution to a puppet
module.
</p>

<p>
I was attempting to configure <a href="https://github.com/SpiderLabs/ModSecurity">ModSecurity</a> using the puppetlabs-apache
puppet module when I discovered that the
<code>/var/log/httpd/modsec_audit.log</code> file contained the request body for
rejected requests. For PCI-DSS reasons, this was not desirous, so I
set out to learn how I could configure ModSecurity to stop doing that.
</p>

<p>
First I consulted the <a href="https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual#SecAuditLogParts">ModSecurity audit log</a> documentation and learnt
that you can choose which sections to include in the audit log with
the <code>SecAuditLogParts</code> directive. Helpfully the audit log file contains
section separators (e.g. <code>--be604c0a-C--</code>) which have a section
identifier&#x2014;in this case <code>C</code>&#x2014;which corresponds to the "request body"
part. So, all I had to do was ensure that I removed <code>C</code> from the
<code>SecAuditLogParts</code> directive. Simples!
</p>

<p>
There was just one <i>teeeny tiny</i> problem. My
<code>/etc/httpd/conf.d/security.conf</code> contained the below line, and <i>look ma</i>,
no <code>C</code> to be seen. Drat.
</p>

<pre class="example">
SecAuditLogParts ABIJDEFHZ
</pre>

<p>
My first thought was that perhaps my config file was not read and
ModSecurity was running with its defaults, which are documented to be
<code>ABCFHZ</code>. Or perhaps there was an error in the config file further up so
it was only partly read<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>. To test this I changed the <code>SecAuditLog</code>
directive (which was the last directive in the file) and restarted
Apache. I provoked ModSecurity again, and lo and behold it logged to
the audit log with the new name. So at least I had confirmed that the
config file was read.
</p>

<p>
I also discovered that my audit log had the <code>E</code> section in them, which
is <i>not</i> in the default, so I went back to re-read the documentation for
the audit log sections. I won't bother you with details of how my lips
moved when carefully reading the text, but here's our culprit:
</p>

<blockquote>
<ul class="org-ul">
<li><b>I</b>: This part is a replacement for part C. It will log the same
data as C in all cases except when multipart/form-data encoding in
used. In this case, it will log a fake
application/x-www-form-urlencoded body that contains the
information about parameters but not about the files. This is handy
if you don't want to have (often large) files stored in your audit
logs.</li>
</ul>
</blockquote>

<p>
Using the <code>C</code> section identifier in the log file when all the other
sections map directly from the section part selector to the section
identifier is unintuitive, to say the least. I wasted quite a lot of
time because of this and <a href="https://github.com/SpiderLabs/ModSecurity/issues/1089">filed an issue</a> about it. I wouldn't be
surprised if it is never fixed as third-party tools rely on the
current behaviour though.
</p>

<p>
Moving on! I now had a plan. All I had to do was remove the <code>I</code> part
selector from the <code>SecAuditLogParts</code> directive. Unfortunately this was
not configurable through <code>puppetlabs-apache</code>. It was hardcoded in the
<code>security.conf.erb</code> template. The plan now became "moaning to friends"
about my situation. In private<sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup>.
</p>

<p>
Turns out I moaned to the right friends. After receiving some
encouragement and pointers from <a href="http://unixdaemon.net">Dean Wilson</a> I set out to contribute
the ability to configure which sections you want printed to the
<code>modsec_audit.log</code> file to <code>puppetlabs-apache</code>. It was much simpler than I
thought, and culminated in a <a href="https://github.com/puppetlabs/puppetlabs-apache/pull/1392">pull request</a> that was merged pretty
swiftly.
</p>

<p>
If you're thinking: "that's cool. I could use that actually. What do I
have to do?" then don't worry&#x2014;I've got your back! It may be a little
while before there's a <a href="https://github.com/puppetlabs/puppetlabs-apache/releases">new release</a>, but if you use <a href="http://bombasticmonkey.com/librarian-puppet/">librarian-puppet</a> to
manage your puppet modules you can easily install the tip of the
current master branch by putting this in your <code>Puppetfile</code>:
</p>

<pre class="example">
mod 'puppetlabs-apache',
  :git =&gt; 'https://github.com/puppetlabs/puppetlabs-apache.git'
</pre>

<p>
You can then select which sections you want printed to the
<code>modsec_audit.log</code> file by putting something like this in a relevant
hiera file:
</p>

<pre class="example">
apache::mod::security::audit_log_parts: ABZ
</pre>

<p>
If you don't use hiera, you can set it directly from a puppet manifest
like so:
</p>

<pre class="example">
class { '::apache::mod::security':
  audit_log_parts =&gt; 'ABZ'
}
</pre>

<p>
By the way, <i>please</i> do not blindly copy <code>ABZ</code> from the above example, but
refer to the <a href="https://github.com/SpiderLabs/ModSecurity/wiki/ModSecurity-2-Data-Formats#audit-log">audit log</a> documentation and make an informed choice as to
which sections you want to log to <i>your</i> audit log. Every app is
different and what's right for mine is not necessarily right for
yours. (Especially since that isn't actually what I use: I just felt
it rolled off the tongue nicely for this example, if you pronounce the
<code>Z</code> like a <code>C</code>, as some are wont.)
</p>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
Although I judged the chance of the latter slim, since no
warnings or errors were logged about corrupt config.
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara"><p class="footpara">
I am a grown-up, and a professional, after all.
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="date">Date: 2016-03-16</p>
<p class="author">Author: Stig Brautaset</p>
<p class="date">Created: 2017-06-07 Wed 16:22</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
