---
title: Hydra Theme Switcher for Emacs
layout: post
abstract: I learnt how to quickly switch between all installed themes in Emacs using Hydra.
tags: [Emacs, Hacks]
---

<p>
I recently read Greg Hendershott's <a href="http://www.greghendershott.com/2017/02/emacs-themes.html">emacs themes</a> blog post, and cribbed
liberally from his approach to loading themes. I also cribbed his
Hydra theme switcher. It was so fun to use! I wanted to try it with
all the themes I have installed&#x2014;but I didn't want to add all of them
manually. Boo! So I set out to see if I could dynamically add all
installed themes to my Hydra theme switcher.
</p>

<p>
First I needed a list of all installed themes. I remembered that when
you do <code>M-x load-theme RET</code> and TAB you get a list of all the themes,
so I started looking there. <code>C-h f load-theme RET</code> brings up the
documentation for that function, and this has a link to the source at
the top. I clicked that, and quickly found that it calls
<code>custom-available-themes</code>.
</p>

<p>
Next I needed to generate the Hydra docstring/menu. My biggest
annoyance with the manual process was modifying the docstring to add
the key &amp; hint. So initially I thought about automating this in some
way, perhaps by listing light &amp; dark &amp; "other" themes separately. But
it would still be annoying. I thought about chaining hydras too, but
then I discovered that Hydra supports a different mode: you can
provide a hint as the third argument in the "head" and it will create
the menu for you. I opted for this approach.
</p>

<p>
I now needed to come up with a strategy for how to select KEYs to
select each theme. First I thought about using mnemonics for the
themes themselves, but I have both <code>leuven</code>, <code>leuven-dark</code>,
<code>light-blue</code>, and <code>liso</code> all starting with <code>l</code>. I then thought about
using shortest unique substring, but that would mean variable-length
keys which I didn't want; as much as possible I wanted
single-keystroke keys. So I decided to go with an alphabet of 62
candidate keys:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">setq</span> sb/hydra-selectors
     <span style="color: #008000;">"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>)
</pre>
</div>

<p>
The list returned by <code>custom-available-themes</code> is not sorted
alphabetically, but I wanted my Hydra menu to present them that way.
It took a while to figure out how to sort the list since it's a list
of symbols rather than strings, and also I spent a long time hunting
for non-destructive sort. (I didn't find any, but it turns out the
list is created every time so it's not necessary.) My theme sorter
looks like this:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">sb/sort-themes</span> (themes)
  (sort themes (<span style="color: #0000FF;">lambda</span> (a b)
                 (string&lt; (symbol-name a) (symbol-name b)))))
</pre>
</div>

<p>
Now I was ready create my Hydra's "heads". These should be of the
form <code>(KEY ACTION HINT)</code>. I had a list of candidate KEYs, and a list
of themes to build the action and hint, but I needed to piece it
together. I struggled to figure out how to correlate the KEY and THEME
using <code>mapcar</code>, but then I noticed <code>mapcar*</code> (final <code>*</code> is
significant) among the autocomplete candidates. This is very similar
to <code>mapcar</code> but takes multiple lists and passes a value from each to
the mapping function. Just what I needed! As a bonus it stops when
<i>either</i> list runs out of items.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">sb/hydra-load-theme-heads</span> (themes)
  (mapcar* (<span style="color: #0000FF;">lambda</span> (a b)
             (list (char-to-string a) `(sb/load-theme ',b) (symbol-name b)))
           sb/hydra-selectors themes))
</pre>
</div>

<p>
The <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Backquote.html#Backquote">backquote</a> (<code>`</code>) in that snippet is similar to quoting with <code>'</code> or
<code>quote</code>, but allows you to selectively <i>unquote</i> bits inside with <code>,</code>.
I need it because I needed to quote the argument to <code>sb/load-theme</code>.
</p>

<p>
<code>defhydra</code> doesn't take a list of heads, but I thought I might find a
related function that would, perhaps <code>defhydra*</code>. Unfortunately, I had
no such luck. However, this is Lisp so there are ways. We'll reach for
backquote again, but this time instead of a simple unquote we <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Backquote.html#Backquote">splice</a>
our heads into the <code>defhydra</code> argument list with <code>,@</code>. This now looked
like so:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(eval `(<span style="color: #0000FF;">defhydra</span> sb/hydra-select-themes (<span style="color: #006FE0;">:hint</span> nil <span style="color: #006FE0;">:color</span> pink)
         <span style="color: #008000;">"Select Theme"</span>
         ,@(sb/hydra-load-theme-heads (sb/sort-themes (custom-available-themes)))
         (<span style="color: #008000;">"DEL"</span> (sb/disable-all-themes))
         (<span style="color: #008000;">"RET"</span> nil <span style="color: #008000;">"done"</span> <span style="color: #006FE0;">:color</span> blue)))
</pre>
</div>

<p>
We then just need to assign a keybinding, which I do like this:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">bind-keys</span> (<span style="color: #008000;">"C-c w t"</span> . sb/hydra-select-themes/body))
</pre>
</div>

<p>
This worked beautifully, except for one issue: if I installed a new
theme it would not show up in my Hydra menu until I manually
re-evaluated the config snippet, or restart Emacs. That's not ideal.
Perusing the Hydra examples revealed <a href="https://github.com/abo-abo/hydra/wiki/Switch-to-buffer">a recipe that assigned the return
value of <code>defhydra</code></a> to the key, so next I tried to rewrite my code to
this:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">bind-keys</span> (<span style="color: #008000;">"C-c w t"</span> .
          (eval `(<span style="color: #0000FF;">defhydra</span> sb/hydra-select-themes (<span style="color: #006FE0;">:hint</span> nil <span style="color: #006FE0;">:color</span> pink)
                   <span style="color: #008000;">"Select Theme"</span>
                   ,@(sb/hydra-load-theme-heads (sb/sort-themes (custom-available-themes)))
                   (<span style="color: #008000;">"DEL"</span> (sb/disable-all-themes))
                   (<span style="color: #008000;">"RET"</span> nil <span style="color: #008000;">"done"</span> <span style="color: #006FE0;">:color</span> blue)))))
</pre>
</div>

<p>
Unfortunately that did not work. Launching the Hydra now I got the
following error:
</p>

<blockquote>
<p>
command-execute: Wrong type argument: commandp, (eval (\` (defhydra sb/hydra-select-themes (:hint nil :color pink) "Select Theme" (\,@ (sb/hydra-load-theme-heads (sb/sort-themes (custom-available-themes)))) ("DEL" (sb/disable-all-themes)) ("RET" nil "done" :color blue))))
</p>
</blockquote>

<p>
I didn't really understand what that meant, but I searched the hydra
issues some more for "dynamic" invocation and found <a href="https://github.com/abo-abo/hydra/issues/137#issuecomment-117132873">a comment</a> with a
recipe that I was able to adapt. It's a bit more faff, and I don't
understand why the <code>call-interactively</code> is necessary, but it works and
here it is:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">bind-keys</span> (<span style="color: #008000;">"C-c w t"</span> .
            (<span style="color: #0000FF;">lambda</span> ()
              (<span style="color: #0000FF;">interactive</span>)
              (call-interactively
               (eval `(<span style="color: #0000FF;">defhydra</span> sb/hydra-select-themes (<span style="color: #006FE0;">:hint</span> nil <span style="color: #006FE0;">:color</span> pink)
                        <span style="color: #008000;">"Select Theme"</span>
                        ,@(sb/hydra-load-theme-heads (sb/sort-themes (custom-available-themes)))
                        (<span style="color: #008000;">"DEL"</span> (sb/disable-all-themes))
                        (<span style="color: #008000;">"RET"</span> nil <span style="color: #008000;">"done"</span> <span style="color: #006FE0;">:color</span> blue)))))))
</pre>
</div>

<p>
For completeness here's the complete source for this switcher:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">sb/disable-all-themes</span> ()
  (<span style="color: #0000FF;">interactive</span>)
  (mapc #'disable-theme custom-enabled-themes))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">sb/load-theme</span> (theme)
  <span style="color: #036A07;">"Enhance `</span><span style="color: #D0372D;">load-theme</span><span style="color: #036A07;">' by first disabling enabled themes."</span>
  (sb/disable-all-themes)
  (load-theme theme))

(<span style="color: #0000FF;">setq</span> sb/hydra-selectors
      <span style="color: #008000;">"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">sb/sort-themes</span> (themes)
  (sort themes (<span style="color: #0000FF;">lambda</span> (a b) (string&lt; (symbol-name a) (symbol-name b)))))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">sb/hydra-load-theme-heads</span> (themes)
  (mapcar* (<span style="color: #0000FF;">lambda</span> (a b)
             (list (char-to-string a) `(sb/load-theme ',b) (symbol-name b)))
           sb/hydra-selectors themes))

(<span style="color: #0000FF;">bind-keys</span> (<span style="color: #008000;">"C-c w t"</span> .
            (<span style="color: #0000FF;">lambda</span> ()
              (<span style="color: #0000FF;">interactive</span>)
              (call-interactively
               (eval `(<span style="color: #0000FF;">defhydra</span> sb/hydra-select-themes (<span style="color: #006FE0;">:hint</span> nil <span style="color: #006FE0;">:color</span> pink)
                        <span style="color: #008000;">"Select Theme"</span>
                        ,@(sb/hydra-load-theme-heads (sb/sort-themes (custom-available-themes)))
                        (<span style="color: #008000;">"DEL"</span> (sb/disable-all-themes))
                        (<span style="color: #008000;">"RET"</span> nil <span style="color: #008000;">"done"</span> <span style="color: #006FE0;">:color</span> blue)))))))
</pre>
</div>

<p>
For what it's worth, here's my full <a href="https://github.com/stig/dot-files/blob/master/emacs.d/Themes.org">Emacs Themes Config</a> on Github.
</p>
